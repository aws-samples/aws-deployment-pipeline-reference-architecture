
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../ri-cdk-pipeline/">
      
      
        <link rel="next" href="../ri-circleci-pipeline/">
      
      
      <link rel="icon" href="../../assets/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.32">
    
    
      
        <title>Amazon CodeCatalyst - Deployment Pipeline Reference Architecture</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.3cba04c6.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-Z5XE517K9W"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-Z5XE517K9W",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-Z5XE517K9W",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="Amazon CodeCatalyst - Deployment Pipeline Reference Architecture" >
      
        <meta  property="og:description"  content="None" >
      
        <meta  property="og:image"  content="./assets/images/social/application-pipeline/ri-codecatalyst-pipeline.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="None" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="Amazon CodeCatalyst - Deployment Pipeline Reference Architecture" >
      
        <meta  name="twitter:description"  content="None" >
      
        <meta  name="twitter:image"  content="./assets/images/social/application-pipeline/ri-codecatalyst-pipeline.png" >
      
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#amazon-codecatalyst-pipeline" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Deployment Pipeline Reference Architecture" class="md-header__button md-logo" aria-label="Deployment Pipeline Reference Architecture" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Deployment Pipeline Reference Architecture
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Amazon CodeCatalyst
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/aws-samples/aws-deployment-pipeline-reference-architecture" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-deployment-pipeline-reference-architecture
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Deployment Pipeline Reference Architecture" class="md-nav__button md-logo" aria-label="Deployment Pipeline Reference Architecture" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    Deployment Pipeline Reference Architecture
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aws-samples/aws-deployment-pipeline-reference-architecture" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-deployment-pipeline-reference-architecture
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Application Pipeline
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Application Pipeline
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Architecture
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Reference Implementations
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Reference Implementations
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ri-cdk-pipeline/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AWS CDK Pipelines
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Amazon CodeCatalyst
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Amazon CodeCatalyst
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#local-development" class="md-nav__link">
    <span class="md-ellipsis">
      Local Development
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#source" class="md-nav__link">
    <span class="md-ellipsis">
      Source
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#build" class="md-nav__link">
    <span class="md-ellipsis">
      Build
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-beta" class="md-nav__link">
    <span class="md-ellipsis">
      Test (Beta)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-gamma" class="md-nav__link">
    <span class="md-ellipsis">
      Test (Gamma)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prod" class="md-nav__link">
    <span class="md-ellipsis">
      Prod
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#frequently-asked-questions" class="md-nav__link">
    <span class="md-ellipsis">
      Frequently Asked Questions
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ri-circleci-pipeline/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CircleCI
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../additional-sources/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Additional Sources
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Dynamic Configuration Pipeline
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Dynamic Configuration Pipeline
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dynamic-configuration-pipeline/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Architecture
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Reference Implementations
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Reference Implementations
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dynamic-configuration-pipeline/ri-cdk-codepipeline-appconfig/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CDK Pipelines + AppConfig
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="amazon-codecatalyst-pipeline">Amazon CodeCatalyst Pipeline<a class="headerlink" href="#amazon-codecatalyst-pipeline" title="Permanent link">&para;</a></h1>
<p>This presents a reference implementation of the <a href="..">Application Pipeline</a> reference architecture. The pipeline is created with <a href="https://aws.amazon.com/codecatalyst/">Amazon CodeCatalyst</a> for building the software and performing testing tasks. All the infrastructure for this reference implementation is defined with <a href="https://aws.amazon.com/cdk/">AWS Cloud Development Kit</a>. The source code for this reference implementation is available in <a href="https://github.com/aws-samples/aws-deployment-pipeline-reference-architecture/tree/main/examples/codecatalyst-application-pipeline">GitHub</a> for review.</p>
<p>This reference implementation has been contributed to Amazon CodeCatalyst as <a href="https://docs.aws.amazon.com/codecatalyst/latest/userguide/concepts.html#templates-concept">blueprint</a> named <code>DevOps deployment pipeline</code>. You can try out this reference implementation in your own CodeCatalyst space by creating a new project from the blueprint.</p>
<p><img alt="Architecture" src="../ri-codecatalyst-pipeline-architecture.drawio-0.svg" /></p>
<details class="danger" open="open">
<summary>Disclaimer</summary>
<p>This reference implementation is intended to serve as an example of how to accomplish the guidance in the reference architecture using <a href="https://aws.amazon.com/codecatalyst/">Amazon CodeCatalyst</a>. The reference implementation has intentionally not followed the following <a href="https://aws.amazon.com/architecture/well-architected/">AWS Well-Architected</a> best practices to make it accessible by a wider range of customers. Be sure to address these before using parts of this code for any workloads in your own environment:</p>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> <strong>cdk bootstrap with AdministratorAccess</strong> - the default policy used for <code>cdk bootstrap</code> is <code>AdministratorAccess</code> but should be replaced with a more appropriate policy with least privilege in your account.</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> <strong>TLS on HTTP endpoint</strong> - the listener for the sample application uses HTTP instead of HTTPS to avoid having to create new ACM certificates and Route53 hosted zones. This should be replaced in your account with an <code>HTTPS</code> listener.</li>
</ul>
</details>
<p><img alt="Pipeline" src="../assets/ri-codecatalyst-pipeline.png" /></p>
<h2 id="local-development">Local Development<a class="headerlink" href="#local-development" title="Permanent link">&para;</a></h2>
<p>Developers need fast-feedback for potential issues with their code. Automation should run in their developer workspace to give them feedback before the deployment pipeline runs.</p>
<details class="required" open="open">
<summary>Pre-Commit Hooks</summary>
<p>Pre-Commit hooks are scripts that are executed on the developer's workstation when they try to create a new commit. These hooks have an opportunity to inspect the state of the code before the commit occurs and abort the commit if tests fail. An example of pre-commit hooks are <a href="https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks#_git_hooks">Git hooks</a>.  Examples of tools to configure and store pre-commit hooks as code include but are not limited to <a href="https://github.com/typicode/husky">husky</a> and <a href="https://pre-commit.com/#install">pre-commit</a>.</p>
<p>The following <code>.pre-commit-config.yaml</code> is added to the repository that will build the code with <a href="https://maven.apache.org/">Maven</a>, run unit tests with <a href="https://junit.org">JUnit</a>, check for code quality with <a href="https://github.com/checkstyle/checkstyle">Checkstyle</a>, run static application security testing with <a href="https://pmd.github.io/latest/index.html">PMD</a> and check for secrets in the code with <a href="https://github.com/zricethezav/gitleaks">gitleaks</a>.</p>
<div class="highlight"><pre><span></span><code><span class="nt">repos</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/pre-commit/pre-commit-hooks</span>
<span class="w">  </span><span class="nt">rev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v2.3.0</span>
<span class="w">  </span><span class="nt">hooks</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w">   </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">check-yaml</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w">   </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">check-json</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w">   </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">trailing-whitespace</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/pre-commit/mirrors-eslint</span>
<span class="w">  </span><span class="nt">rev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v8.23.0</span>
<span class="w">  </span><span class="nt">hooks</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w">   </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">eslint</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/ejba/pre-commit-maven</span>
<span class="w">  </span><span class="nt">rev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v0.3.3</span>
<span class="w">  </span><span class="nt">hooks</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w">   </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">maven-test</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/zricethezav/gitleaks</span>
<span class="w">  </span><span class="nt">rev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v8.12.0</span>
<span class="w">  </span><span class="nt">hooks</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gitleaks</span>
</code></pre></div>
</details>
<h2 id="source">Source<a class="headerlink" href="#source" title="Permanent link">&para;</a></h2>
<details class="required" open="open">
<summary>Application Source Code</summary>
<p>The application source code can be found in the <a href="https://github.com/aws-samples/aws-deployment-pipeline-reference-architecture/tree/main/examples/codecatalyst-application-pipeline/src/main/java">src/main/java</a> directory. It is intended to serve only as a reference and should be replaced by your own application source code.</p>
<p>This reference implementation includes a <a href="https://spring.io/projects/spring-boot">Spring Boot</a> application that exposes a REST API and uses a database for persistence. The API is implemented in <code>FruitController.java</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">FruitController</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * JPA repository for fruits.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">FruitRepository</span><span class="w"> </span><span class="n">repository</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Logic to map between entities and DTOs</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">FruitMapper</span><span class="w"> </span><span class="n">mapper</span><span class="p">;</span>

<span class="w">    </span><span class="n">FruitController</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">FruitRepository</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">FruitMapper</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">repository</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">mapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/api/fruits&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">FruitDTO</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">all</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">findAll</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">mapper</span><span class="p">::</span><span class="n">toDto</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/api/fruits&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">FruitDTO</span><span class="w"> </span><span class="nf">newFruit</span><span class="p">(</span><span class="nd">@RequestBody</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">FruitDTO</span><span class="w"> </span><span class="n">fruit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">mapper</span><span class="p">.</span><span class="na">toDto</span><span class="p">(</span><span class="n">repository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">mapper</span><span class="p">.</span><span class="na">toEntity</span><span class="p">(</span><span class="n">fruit</span><span class="p">)));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/api/fruits/{id}&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">FruitDTO</span><span class="w"> </span><span class="nf">one</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">mapper</span><span class="p">::</span><span class="n">toDto</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FruitNotFoundException</span><span class="p">(</span><span class="n">id</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@PutMapping</span><span class="p">(</span><span class="s">&quot;/api/fruits/{id}&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">FruitDTO</span><span class="w"> </span><span class="nf">replaceFruit</span><span class="p">(</span>
<span class="w">            </span><span class="nd">@RequestBody</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">FruitDTO</span><span class="w"> </span><span class="n">newFruit</span><span class="p">,</span>
<span class="w">            </span><span class="nd">@PathVariable</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">newFruit</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">mapper</span><span class="p">.</span><span class="na">toDto</span><span class="p">(</span><span class="n">repository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">mapper</span><span class="p">.</span><span class="na">toEntity</span><span class="p">(</span><span class="n">newFruit</span><span class="p">)));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@DeleteMapping</span><span class="p">(</span><span class="s">&quot;/api/fruits/{id}&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">deleteFruit</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">repository</span><span class="p">.</span><span class="na">deleteById</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>The application source code is stored in <a href="https://aws.amazon.com/codecatalyst/">Amazon CodeCatalyst</a> repository that is created and initialized from the blueprint.</p>
</details>
<details class="required" open="open">
<summary>Test Source Code</summary>
<p>The test source code can be found in the <a href="https://github.com/aws-samples/aws-deployment-pipeline-reference-architecture/tree/main/examples/codecatalyst-application-pipeline/src/test/java">src/test/java</a> directory. It is intended to serve only as a reference and should be replaced by your own test source code.</p>
<p>The reference implementation includes source code for unit, integration and end-to-end testing. Unit and integration tests can be found in <code>src/test/java</code>. For example, <code>FruitControllerWithoutClassificationTest.java</code> performs unit tests of each API path with the <a href="https://junit.org/">JUnit</a> testing library:</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldReturnList</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">repository</span><span class="p">.</span><span class="na">findAll</span><span class="p">()).</span><span class="na">thenReturn</span><span class="p">(</span><span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Fruit</span><span class="p">(</span><span class="s">&quot;Mango&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">FruitClassification</span><span class="p">.</span><span class="na">pome</span><span class="p">),</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Fruit</span><span class="p">(</span><span class="s">&quot;Dragonfruit&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">FruitClassification</span><span class="p">.</span><span class="na">berry</span><span class="p">)));</span>

<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="na">mockMvc</span><span class="p">.</span><span class="na">perform</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;/api/fruits&quot;</span><span class="p">)).</span><span class="na">andDo</span><span class="p">(</span><span class="n">print</span><span class="p">()).</span><span class="na">andExpect</span><span class="p">(</span><span class="n">status</span><span class="p">().</span><span class="na">isOk</span><span class="p">())</span>
<span class="w">      </span><span class="p">.</span><span class="na">andExpect</span><span class="p">(</span><span class="n">content</span><span class="p">().</span><span class="na">json</span><span class="p">(</span><span class="s">&quot;[{\&quot;name\&quot;: \&quot;Mango\&quot;}, {\&quot;name\&quot;: \&quot;Dragonfruit\&quot;}]&quot;</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<p>Acceptance tests are preformed with <a href="https://www.soapui.org/">SoapUI</a> and are defined in <code>fruit-api-soapui-project.xml</code>. They are executed by <a href="https://maven.apache.org/">Maven</a> using plugins in <code>pom.xml</code>.</p>
</details>
<details class="required" open="open">
<summary>Infrastructure Source Code</summary>
<p>The infrastructure source code can be found in the <a href="https://github.com/aws-samples/aws-deployment-pipeline-reference-architecture/tree/main/examples/codecatalyst-application-pipeline/infrastructure">infrastructure</a> directory. It is intended to serve as a reference but much of the code can also be reused in your own CDK applications.</p>
<p>Infrastructure source code defines the deployment of the application are stored in <code>infrastructure/</code> folder and uses <a href="https://aws.amazon.com/cdk/">AWS Cloud Development Kit</a>.</p>
<div class="highlight"><pre><span></span><code><span class="k">super</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">props</span><span class="p">);</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">AssetImage</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;build&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">appName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Stack</span><span class="p">.</span><span class="k">of</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="nx">stackName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
<span class="w">  </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sb">`-</span><span class="si">${</span><span class="nx">Stack</span><span class="p">.</span><span class="k">of</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">region</span><span class="si">}</span><span class="sb">-`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;-&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">vpc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ec2</span><span class="p">.</span><span class="nx">Vpc</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Vpc&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">maxAzs</span><span class="o">:</span><span class="w"> </span><span class="kt">3</span><span class="p">,</span>
<span class="w">  </span><span class="nx">natGateways</span><span class="o">:</span><span class="w"> </span><span class="kt">props?.natGateways</span><span class="p">,</span>
<span class="p">});</span>
<span class="ow">new</span><span class="w"> </span><span class="nx">FlowLog</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;VpcFlowLog&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">resourceType</span><span class="o">:</span><span class="w"> </span><span class="kt">FlowLogResourceType.fromVpc</span><span class="p">(</span><span class="nx">vpc</span><span class="p">),</span>
<span class="p">});</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">dbName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;fruits&#39;</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">dbSecret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">DatabaseSecret</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;AuroraSecret&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;fruitapi&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">secretName</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">appName</span><span class="si">}</span><span class="sb">-DB`</span><span class="p">,</span>
<span class="p">});</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">DatabaseCluster</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Database&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">engine</span><span class="o">:</span><span class="w"> </span><span class="kt">DatabaseClusterEngine.auroraMysql</span><span class="p">({</span>
<span class="w">    </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="kt">AuroraMysqlEngineVersion.VER_3_07_1</span><span class="p">,</span>
<span class="w">  </span><span class="p">}),</span>
<span class="w">  </span><span class="nx">credentials</span><span class="o">:</span><span class="w"> </span><span class="kt">Credentials.fromSecret</span><span class="p">(</span><span class="nx">dbSecret</span><span class="p">),</span>
<span class="w">  </span><span class="nx">writer</span><span class="o">:</span><span class="w"> </span><span class="kt">ClusterInstance.serverlessV2</span><span class="p">(</span><span class="s1">&#39;writer&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="nx">defaultDatabaseName</span><span class="o">:</span><span class="w"> </span><span class="kt">dbName</span><span class="p">,</span>
<span class="w">  </span><span class="nx">serverlessV2MaxCapacity</span><span class="o">:</span><span class="w"> </span><span class="kt">2</span><span class="p">,</span>
<span class="w">  </span><span class="nx">serverlessV2MinCapacity</span><span class="o">:</span><span class="w"> </span><span class="kt">0.5</span><span class="p">,</span>
<span class="w">  </span><span class="nx">vpc</span><span class="p">,</span>
<span class="w">  </span><span class="nx">clusterIdentifier</span><span class="o">:</span><span class="w"> </span><span class="kt">appName</span><span class="p">,</span>
<span class="w">  </span><span class="nx">storageEncrypted</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="p">});</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">cluster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ecs</span><span class="p">.</span><span class="nx">Cluster</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Cluster&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">vpc</span><span class="p">,</span>
<span class="w">  </span><span class="nx">containerInsights</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="w">  </span><span class="nx">clusterName</span><span class="o">:</span><span class="w"> </span><span class="kt">appName</span><span class="p">,</span>
<span class="p">});</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">appLogGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">LogGroup</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;AppLogGroup&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">retention</span><span class="o">:</span><span class="w"> </span><span class="kt">RetentionDays.ONE_WEEK</span><span class="p">,</span>
<span class="w">  </span><span class="nx">logGroupName</span><span class="o">:</span><span class="w"> </span><span class="sb">`/aws/ecs/service/</span><span class="si">${</span><span class="nx">appName</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">  </span><span class="nx">removalPolicy</span><span class="o">:</span><span class="w"> </span><span class="kt">RemovalPolicy.DESTROY</span><span class="p">,</span>
<span class="p">});</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">deploymentConfig</span><span class="o">:</span><span class="w"> </span><span class="kt">IEcsDeploymentConfig</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">props</span><span class="o">?</span><span class="p">.</span><span class="nx">deploymentConfigName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">deploymentConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">EcsDeploymentConfig</span><span class="p">.</span><span class="nx">fromEcsDeploymentConfigName</span><span class="p">(</span>
<span class="w">    </span><span class="k">this</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;DeploymentConfig&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">props</span><span class="p">.</span><span class="nx">deploymentConfigName</span><span class="p">,</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">appConfigEnabled</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="nx">props</span><span class="o">?</span><span class="p">.</span><span class="nx">appConfigRoleArn</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">  </span><span class="nx">props</span><span class="p">.</span><span class="nx">appConfigRoleArn</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ApplicationLoadBalancedCodeDeployedFargateService</span><span class="p">(</span>
<span class="w">  </span><span class="k">this</span><span class="p">,</span>
<span class="w">  </span><span class="s1">&#39;Api&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nx">cluster</span><span class="p">,</span>
<span class="w">    </span><span class="nx">capacityProviderStrategies</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">capacityProvider</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;FARGATE_SPOT&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">weight</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nx">minHealthyPercent</span><span class="o">:</span><span class="w"> </span><span class="kt">50</span><span class="p">,</span>
<span class="w">    </span><span class="nx">maxHealthyPercent</span><span class="o">:</span><span class="w"> </span><span class="kt">200</span><span class="p">,</span>
<span class="w">    </span><span class="nx">desiredCount</span><span class="o">:</span><span class="w"> </span><span class="kt">3</span><span class="p">,</span>
<span class="w">    </span><span class="nx">cpu</span><span class="o">:</span><span class="w"> </span><span class="kt">512</span><span class="p">,</span>
<span class="w">    </span><span class="nx">memoryLimitMiB</span><span class="o">:</span><span class="w"> </span><span class="kt">1024</span><span class="p">,</span>
<span class="w">    </span><span class="nx">taskImageOptions</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">image</span><span class="p">,</span>
<span class="w">      </span><span class="nx">containerName</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">containerPort</span><span class="o">:</span><span class="w"> </span><span class="kt">8080</span><span class="p">,</span>
<span class="w">      </span><span class="nx">family</span><span class="o">:</span><span class="w"> </span><span class="kt">appName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">logDriver</span><span class="o">:</span><span class="w"> </span><span class="kt">AwsLogDriver.awsLogs</span><span class="p">({</span>
<span class="w">        </span><span class="nx">logGroup</span><span class="o">:</span><span class="w"> </span><span class="kt">appLogGroup</span><span class="p">,</span>
<span class="w">        </span><span class="nx">streamPrefix</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;service&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">}),</span>
<span class="w">      </span><span class="nx">secrets</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">SPRING_DATASOURCE_USERNAME</span><span class="o">:</span><span class="w"> </span><span class="kt">Secret.fromSecretsManager</span><span class="p">(</span>
<span class="w">          </span><span class="nx">dbSecret</span><span class="p">,</span>
<span class="w">          </span><span class="s1">&#39;username&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="p">),</span>
<span class="w">        </span><span class="nx">SPRING_DATASOURCE_PASSWORD</span><span class="o">:</span><span class="w"> </span><span class="kt">Secret.fromSecretsManager</span><span class="p">(</span>
<span class="w">          </span><span class="nx">dbSecret</span><span class="p">,</span>
<span class="w">          </span><span class="s1">&#39;password&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="p">),</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">environment</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">SPRING_DATASOURCE_URL</span><span class="o">:</span><span class="w"> </span><span class="sb">`jdbc:mysql://</span><span class="si">${</span><span class="nx">db</span><span class="p">.</span><span class="nx">clusterEndpoint</span><span class="p">.</span><span class="nx">hostname</span><span class="si">}</span><span class="sb">:</span><span class="si">${</span><span class="nx">db</span><span class="p">.</span><span class="nx">clusterEndpoint</span><span class="p">.</span><span class="nx">port</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">dbName</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">        </span><span class="nx">APPCONFIG_AGENT_APPLICATION</span><span class="o">:</span>
<span class="w">          </span><span class="kt">this.node.tryGetContext</span><span class="p">(</span><span class="s1">&#39;workloadName&#39;</span><span class="p">),</span>
<span class="w">        </span><span class="nx">APPCONFIG_AGENT_ENVIRONMENT</span><span class="o">:</span>
<span class="w">          </span><span class="kt">this.node.tryGetContext</span><span class="p">(</span><span class="s1">&#39;environmentName&#39;</span><span class="p">),</span>
<span class="w">        </span><span class="nx">APPCONFIG_AGENT_ENABLED</span><span class="o">:</span><span class="w"> </span><span class="kt">appConfigEnabled.toString</span><span class="p">(),</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">deregistrationDelay</span><span class="o">:</span><span class="w"> </span><span class="kt">Duration.seconds</span><span class="p">(</span><span class="mf">5</span><span class="p">),</span>
<span class="w">    </span><span class="nx">responseTimeAlarmThreshold</span><span class="o">:</span><span class="w"> </span><span class="kt">Duration.seconds</span><span class="p">(</span><span class="mf">3</span><span class="p">),</span>
<span class="w">    </span><span class="nx">targetHealthCheck</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">healthyThresholdCount</span><span class="o">:</span><span class="w"> </span><span class="kt">2</span><span class="p">,</span>
<span class="w">      </span><span class="nx">unhealthyThresholdCount</span><span class="o">:</span><span class="w"> </span><span class="kt">2</span><span class="p">,</span>
<span class="w">      </span><span class="nx">interval</span><span class="o">:</span><span class="w"> </span><span class="kt">Duration.seconds</span><span class="p">(</span><span class="mf">60</span><span class="p">),</span>
<span class="w">      </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/actuator/health&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">deploymentConfig</span><span class="p">,</span>
<span class="w">    </span><span class="nx">terminationWaitTime</span><span class="o">:</span><span class="w"> </span><span class="kt">Duration.minutes</span><span class="p">(</span><span class="mf">5</span><span class="p">),</span>
<span class="w">    </span><span class="nx">apiCanaryTimeout</span><span class="o">:</span><span class="w"> </span><span class="kt">Duration.seconds</span><span class="p">(</span><span class="mf">5</span><span class="p">),</span>
<span class="w">    </span><span class="nx">apiTestSteps</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;getAll&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/api/fruits&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">jmesPath</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;length(@)&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">expectedValue</span><span class="o">:</span><span class="w"> </span><span class="kt">5</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">);</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">appConfigEnabled</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">service</span><span class="p">.</span><span class="nx">taskDefinition</span><span class="p">.</span><span class="nx">addContainer</span><span class="p">(</span><span class="s1">&#39;appconfig-agent&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">image</span><span class="o">:</span><span class="w"> </span><span class="kt">ecs.ContainerImage.fromRegistry</span><span class="p">(</span>
<span class="w">      </span><span class="s1">&#39;public.ecr.aws/aws-appconfig/aws-appconfig-agent:2.x&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">),</span>
<span class="w">    </span><span class="nx">essential</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span>
<span class="w">    </span><span class="nx">logging</span><span class="o">:</span><span class="w"> </span><span class="kt">AwsLogDriver.awsLogs</span><span class="p">({</span>
<span class="w">      </span><span class="nx">logGroup</span><span class="o">:</span><span class="w"> </span><span class="kt">appLogGroup</span><span class="p">,</span>
<span class="w">      </span><span class="nx">streamPrefix</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;service&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">}),</span>
<span class="w">    </span><span class="nx">environment</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">SERVICE_REGION</span><span class="o">:</span><span class="w"> </span><span class="kt">this.region</span><span class="p">,</span>
<span class="w">      </span><span class="nx">ROLE_ARN</span><span class="o">:</span><span class="w"> </span><span class="kt">props</span><span class="o">!</span><span class="p">.</span><span class="nx">appConfigRoleArn</span><span class="o">!</span><span class="p">,</span>
<span class="w">      </span><span class="nx">ROLE_SESSION_NAME</span><span class="o">:</span><span class="w"> </span><span class="kt">appName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">LOG_LEVEL</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;info&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">portMappings</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span><span class="w"> </span><span class="nx">containerPort</span><span class="o">:</span><span class="w"> </span><span class="kt">2772</span><span class="w"> </span><span class="p">}],</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">service</span><span class="p">.</span><span class="nx">taskDefinition</span><span class="p">.</span><span class="nx">addToTaskRolePolicy</span><span class="p">(</span>
<span class="w">    </span><span class="ow">new</span><span class="w"> </span><span class="nx">PolicyStatement</span><span class="p">({</span>
<span class="w">      </span><span class="nx">actions</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;sts:AssumeRole&#39;</span><span class="p">],</span>
<span class="w">      </span><span class="nx">resources</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nx">props</span><span class="o">!</span><span class="p">.</span><span class="nx">appConfigRoleArn</span><span class="o">!</span><span class="p">],</span>
<span class="w">    </span><span class="p">}),</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">service</span><span class="p">.</span><span class="nx">service</span><span class="p">.</span><span class="nx">connections</span><span class="p">.</span><span class="nx">allowTo</span><span class="p">(</span>
<span class="w">  </span><span class="nx">db</span><span class="p">,</span>
<span class="w">  </span><span class="nx">ec2</span><span class="p">.</span><span class="nx">Port</span><span class="p">.</span><span class="nx">tcp</span><span class="p">(</span><span class="nx">db</span><span class="p">.</span><span class="nx">clusterEndpoint</span><span class="p">.</span><span class="nx">port</span><span class="p">),</span>
<span class="p">);</span>

<span class="k">this</span><span class="p">.</span><span class="nx">apiUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">CfnOutput</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;endpointUrl&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="sb">`http://</span><span class="si">${</span><span class="nx">service</span><span class="p">.</span><span class="nx">listener</span><span class="p">.</span><span class="nx">loadBalancer</span><span class="p">.</span><span class="nx">loadBalancerDnsName</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="p">});</span>
</code></pre></div>
<p>Notice that the infrastructure code is written in <a href="https://www.typescriptlang.org/">Typescript</a> which is different from the Application Source Code (Java). This was done intentionally to demonstrate that CDK allows defining infrastructure code in whatever language is most appropriate for the team that owns the use of CDK in the organization.</p>
</details>
<details class="required" open="open">
<summary>Static Assets</summary>
<p>There are no static assets used by the sample application.</p>
</details>
<details class="required" open="open">
<summary>Dependency Manifests</summary>
<p>All third-party dependencies used by the sample application are define in the <code>pom.xml</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;dependencies&gt;</span>
<span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
<span class="w">        </span><span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
<span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
<span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
<span class="w">        </span><span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
<span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-jpa<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
<span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
<span class="w">        </span><span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
<span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
<span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
<span class="w">        </span><span class="nt">&lt;groupId&gt;</span>org.liquibase<span class="nt">&lt;/groupId&gt;</span>
<span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>liquibase-core<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
</code></pre></div>
</details>
<details class="required" open="open">
<summary>Static Configuration</summary>
<p>Static configuration for the application is defined in <code>src/main/resources/application.yml</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nt">spring</span><span class="p">:</span>
<span class="w">  </span><span class="nt">application</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit-api</span>
<span class="w">  </span><span class="nt">main</span><span class="p">:</span>
<span class="w">    </span><span class="nt">banner-mode</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;off&quot;</span>
<span class="w">  </span><span class="nt">jackson</span><span class="p">:</span>
<span class="w">    </span><span class="nt">default-property-inclusion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">non_null</span>


<span class="nt">springdoc</span><span class="p">:</span>
<span class="w">  </span><span class="nt">swagger-ui</span><span class="p">:</span>
<span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/swagger-ui</span>

<span class="nt">appconfig-agent</span><span class="p">:</span>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">alpha</span>
<span class="w">  </span><span class="nt">log-level-from</span><span class="p">:</span>
<span class="w">    </span><span class="nt">configuration</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">operations</span>
</code></pre></div>
</details>
<details class="required" open="open">
<summary>Database Source Code</summary>
<p>The database source code can be found in the <a href="https://github.com/aws-samples/aws-deployment-pipeline-reference-architecture/tree/main/examples/codecatalyst-application-pipeline/src/main/resources/db">src/main/resources/db</a> directory. It is intended to serve only as a reference and should be replaced by your own database source code.</p>
<p>The code that manages the schema and initial data for the application is defined using <a href="https://www.liquibase.org/">Liquibase</a> in <code>src/main/resources/db/changelog/db.changelog-master.yml</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nt">databaseChangeLog</span><span class="p">:</span>
<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">changeSet</span><span class="p">:</span>
<span class="w">       </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">       </span><span class="nt">author</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS</span>
<span class="w">       </span><span class="nt">changes</span><span class="p">:</span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">createTable</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">id</span>
<span class="w">               </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bigint</span>
<span class="w">               </span><span class="nt">autoIncrement</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">               </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">                   </span><span class="nt">primaryKey</span><span class="p">:</span><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">                   </span><span class="nt">nullable</span><span class="p">:</span><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span>
<span class="w">               </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">varchar(250)</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">insert</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Apple</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">insert</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Orange</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">insert</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Banana</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">insert</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Cherry</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">insert</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Grape</span>

<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">changeSet</span><span class="p">:</span>
<span class="w">       </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2&quot;</span>
<span class="w">       </span><span class="nt">author</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS</span>
<span class="w">       </span><span class="nt">changes</span><span class="p">:</span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">addColumn</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">classification</span>
<span class="w">               </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">varchar(250)</span>
<span class="w">               </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">                 </span><span class="nt">nullable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">update</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">classification</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pome</span>
<span class="w">           </span><span class="nt">where</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name=&#39;Apple&#39;</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">update</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">classification</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">berry</span>
<span class="w">           </span><span class="nt">where</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name=&#39;Orange&#39;</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">update</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">classification</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">berry</span>
<span class="w">           </span><span class="nt">where</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name=&#39;Banana&#39;</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">update</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">classification</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">drupe</span>
<span class="w">           </span><span class="nt">where</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name=&#39;Cherry&#39;</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">update</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">classification</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">berry</span>
<span class="w">           </span><span class="nt">where</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name=&#39;Grape&#39;</span>
</code></pre></div>
</details>
<h2 id="build">Build<a class="headerlink" href="#build" title="Permanent link">&para;</a></h2>
<p>Actions in this stage all run in less than 10 minutes so that developers can take action on fast feedback before moving on to their next task. Each of the actions below are defined as code with <a href="https://aws.amazon.com/cdk/">AWS Cloud Development Kit</a>.</p>
<details class="required" open="open">
<summary>Build Code</summary>
<p>The Java source code is compiled, unit tested and packaged by <a href="https://maven.apache.org/">Maven</a>. An action is added to the workflow to build and package the source code:</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nt">Package</span><span class="p">:</span>
<span class="w">    </span><span class="nt">Identifier</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws/build@v1</span>
<span class="w">    </span><span class="nt">Inputs</span><span class="p">:</span>
<span class="w">      </span><span class="nt">Sources</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">WorkflowSource</span>
<span class="w">    </span><span class="nt">Outputs</span><span class="p">:</span>
<span class="w">      </span><span class="nt">AutoDiscoverReports</span><span class="p">:</span>
<span class="w">        </span><span class="nt">Enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">        </span><span class="nt">ReportNamePrefix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="w">        </span><span class="nt">SuccessCriteria</span><span class="p">:</span>
<span class="w">          </span><span class="nt">PassRate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
<span class="w">      </span><span class="nt">Artifacts</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">package</span>
<span class="w">          </span><span class="nt">Files</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;**/*&quot;</span>
<span class="w">    </span><span class="nt">Configuration</span><span class="p">:</span>
<span class="w">      </span><span class="nt">Steps</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mvn verify --batch-mode --no-transfer-progress</span>
</code></pre></div>
</details>
<details class="required" open="open">
<summary>Unit Tests</summary>
<p>The unit tests are run by <a href="https://maven.apache.org/">Maven</a> at the same time the <code>Build Code</code> action occurs. The results of the unit tests are uploaded to <a href="https://docs.aws.amazon.com/codebuild/latest/userguide/test-reporting.html">AWS Code Build Test Reports</a> to track over time.</p>
<p><img alt="" src="../assets/codecatalyst-unit-test-report.png" /></p>
</details>
<details class="required" open="open">
<summary>Code Quality</summary>
<p>Code quality is enforced through the <a href="https://maven.apache.org/plugins/maven-pmd-plugin/">PMD</a> and <a href="https://maven.apache.org/plugins/maven-checkstyle-plugin/">Checkstyle</a> Maven plugins:</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="nt">&lt;plugin&gt;</span>
<span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>maven-pmd-plugin<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">        </span><span class="nt">&lt;configuration&gt;</span>
<span class="w">            </span><span class="nt">&lt;printFailingErrors&gt;&lt;/printFailingErrors&gt;</span>
<span class="w">        </span><span class="nt">&lt;/configuration&gt;</span>
<span class="w">        </span><span class="nt">&lt;executions&gt;</span>
<span class="w">            </span><span class="nt">&lt;execution&gt;</span>
<span class="w">                </span><span class="nt">&lt;phase&gt;</span>test<span class="nt">&lt;/phase&gt;</span>
<span class="w">                </span><span class="nt">&lt;goals&gt;</span>
<span class="w">                    </span><span class="nt">&lt;goal&gt;</span>check<span class="nt">&lt;/goal&gt;</span>
<span class="w">                </span><span class="nt">&lt;/goals&gt;</span>
<span class="w">            </span><span class="nt">&lt;/execution&gt;</span>
<span class="w">        </span><span class="nt">&lt;/executions&gt;</span>
<span class="w">    </span><span class="nt">&lt;/plugin&gt;</span>
<span class="w">    </span><span class="nt">&lt;plugin&gt;</span>
<span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>maven-checkstyle-plugin<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">        </span><span class="nt">&lt;configuration&gt;</span>
<span class="w">            </span><span class="nt">&lt;printFailingErrors&gt;&lt;/printFailingErrors&gt;</span>
<span class="w">        </span><span class="nt">&lt;/configuration&gt;</span>
<span class="w">        </span><span class="nt">&lt;executions&gt;</span>
<span class="w">            </span><span class="nt">&lt;execution&gt;</span>
<span class="w">                </span><span class="nt">&lt;phase&gt;</span>test<span class="nt">&lt;/phase&gt;</span>
<span class="w">                </span><span class="nt">&lt;goals&gt;</span>
<span class="w">                    </span><span class="nt">&lt;goal&gt;</span>check<span class="nt">&lt;/goal&gt;</span>
<span class="w">                </span><span class="nt">&lt;/goals&gt;</span>
<span class="w">            </span><span class="nt">&lt;/execution&gt;</span>
<span class="w">        </span><span class="nt">&lt;/executions&gt;</span>
<span class="w">    </span><span class="nt">&lt;/plugin&gt;</span>
</code></pre></div>
<p>Additionally, <a href="https://github.com/cdklabs/cdk-nag">cdk-nag</a> is run against the deployment stack to identify any security issues with the resources being created. The pipeline will fail if any are detected. The following code demonstrates how cdk-nag is called as a part of the build stage. The code also demonstrates how to suppress findings.</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">App</span><span class="p">,</span><span class="w"> </span><span class="nx">Aspects</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;aws-cdk-lib&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Annotations</span><span class="p">,</span><span class="w"> </span><span class="nx">Match</span><span class="p">,</span><span class="w"> </span><span class="nx">Template</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;aws-cdk-lib/assertions&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">SynthesisMessage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;aws-cdk-lib/cx-api&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">AwsSolutionsChecks</span><span class="p">,</span><span class="w"> </span><span class="nx">NagSuppressions</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;cdk-nag&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">DeploymentStack</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../src/deployment&#39;</span><span class="p">;</span>


<span class="kd">function</span><span class="w"> </span><span class="nx">synthesisMessageToString</span><span class="p">(</span><span class="nx">sm</span><span class="o">:</span><span class="w"> </span><span class="kt">SynthesisMessage</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">sm</span><span class="p">.</span><span class="nx">entry</span><span class="p">.</span><span class="nx">data</span><span class="si">}</span><span class="sb"> [</span><span class="si">${</span><span class="nx">sm</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">]`</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">expect</span><span class="p">.</span><span class="nx">addSnapshotSerializer</span><span class="p">({</span>
<span class="w">  </span><span class="nx">test</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">val</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">val</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">val</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^dummy.dkr.ecr.us-east.1/</span><span class="p">)</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">  </span><span class="nx">serialize</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s1">&#39;&quot;dummy-ecr-image&quot;&#39;</span><span class="p">,</span>
<span class="p">});</span>
<span class="nx">expect</span><span class="p">.</span><span class="nx">addSnapshotSerializer</span><span class="p">({</span>
<span class="w">  </span><span class="nx">test</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">val</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">val</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">val</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^[a-f0-9]+\.zip$/</span><span class="p">)</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">  </span><span class="nx">serialize</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s1">&#39;&quot;code.zip&quot;&#39;</span><span class="p">,</span>
<span class="p">});</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;cdk-nag&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">stack</span><span class="o">:</span><span class="w"> </span><span class="kt">DeploymentStack</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">app</span><span class="o">:</span><span class="w"> </span><span class="kt">App</span><span class="p">;</span>

<span class="w">  </span><span class="nx">beforeAll</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">appName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;fruit-api&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">workloadName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;food&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">environmentName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;unit-test&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">App</span><span class="p">({</span><span class="w"> </span><span class="nx">context</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">appName</span><span class="p">,</span><span class="w"> </span><span class="nx">environmentName</span><span class="p">,</span><span class="w"> </span><span class="nx">workloadName</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="nx">stack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">DeploymentStack</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;TestStack&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">env</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">account</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;dummy&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">region</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;us-east-1&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="nx">Aspects</span><span class="p">.</span><span class="k">of</span><span class="p">(</span><span class="nx">stack</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">AwsSolutionsChecks</span><span class="p">());</span>

<span class="w">    </span><span class="c1">// Suppress CDK-NAG for TaskDefinition role and ecr:GetAuthorizationToken permission</span>
<span class="w">    </span><span class="nx">NagSuppressions</span><span class="p">.</span><span class="nx">addResourceSuppressionsByPath</span><span class="p">(</span>
<span class="w">      </span><span class="nx">stack</span><span class="p">,</span>
<span class="w">      </span><span class="sb">`/</span><span class="si">${</span><span class="nx">stack</span><span class="p">.</span><span class="nx">stackName</span><span class="si">}</span><span class="sb">/Api/TaskDef/ExecutionRole/DefaultPolicy/Resource`</span><span class="p">,</span>
<span class="w">      </span><span class="p">[{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;AwsSolutions-IAM5&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Allow ecr:GetAuthorizationToken&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">appliesTo</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;Resource::*&#39;</span><span class="p">]</span><span class="w"> </span><span class="p">}],</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Suppress CDK-NAG for secret rotation</span>
<span class="w">    </span><span class="nx">NagSuppressions</span><span class="p">.</span><span class="nx">addResourceSuppressionsByPath</span><span class="p">(</span>
<span class="w">      </span><span class="nx">stack</span><span class="p">,</span>
<span class="w">      </span><span class="sb">`/</span><span class="si">${</span><span class="nx">stack</span><span class="p">.</span><span class="nx">stackName</span><span class="si">}</span><span class="sb">/AuroraSecret/Resource`</span><span class="p">,</span>
<span class="w">      </span><span class="p">[{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;AwsSolutions-SMG4&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Dont require secret rotation&#39;</span><span class="w"> </span><span class="p">}],</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Suppress CDK-NAG for RDS Serverless</span>
<span class="w">    </span><span class="nx">NagSuppressions</span><span class="p">.</span><span class="nx">addResourceSuppressionsByPath</span><span class="p">(</span>
<span class="w">      </span><span class="nx">stack</span><span class="p">,</span>
<span class="w">      </span><span class="sb">`/</span><span class="si">${</span><span class="nx">stack</span><span class="p">.</span><span class="nx">stackName</span><span class="si">}</span><span class="sb">/Database/Resource`</span><span class="p">,</span>
<span class="w">      </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;AwsSolutions-RDS6&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;IAM authentication not supported on Serverless v1&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;AwsSolutions-RDS10&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Disable delete protection to simplify cleanup of Reference Implementation&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;AwsSolutions-RDS11&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Custom port not supported on Serverless v1&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;AwsSolutions-RDS14&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Backtrack not supported on Serverless v1&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;AwsSolutions-RDS16&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;CloudWatch Log Export not supported on Serverless v1&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">],</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="nx">NagSuppressions</span><span class="p">.</span><span class="nx">addResourceSuppressionsByPath</span><span class="p">(</span><span class="nx">stack</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="sb">`/</span><span class="si">${</span><span class="nx">stack</span><span class="p">.</span><span class="nx">stackName</span><span class="si">}</span><span class="sb">/Api/DeploymentGroup/Deployment/DeploymentProvider/framework-onEvent`</span><span class="p">,</span>
<span class="w">      </span><span class="sb">`/</span><span class="si">${</span><span class="nx">stack</span><span class="p">.</span><span class="nx">stackName</span><span class="si">}</span><span class="sb">/Api/DeploymentGroup/Deployment/DeploymentProvider/framework-isComplete`</span><span class="p">,</span>
<span class="w">      </span><span class="sb">`/</span><span class="si">${</span><span class="nx">stack</span><span class="p">.</span><span class="nx">stackName</span><span class="si">}</span><span class="sb">/Api/DeploymentGroup/Deployment/DeploymentProvider/framework-onTimeout`</span><span class="p">,</span>
<span class="w">      </span><span class="sb">`/</span><span class="si">${</span><span class="nx">stack</span><span class="p">.</span><span class="nx">stackName</span><span class="si">}</span><span class="sb">/Api/DeploymentGroup/Deployment/DeploymentProvider/waiter-state-machine`</span><span class="p">,</span>
<span class="w">    </span><span class="p">],</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;AwsSolutions-IAM5&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unrelated to construct under test&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;AwsSolutions-L1&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unrelated to construct under test&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;AwsSolutions-SF1&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unrelated to construct under test&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;AwsSolutions-SF2&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unrelated to construct under test&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">],</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Ignore findings from access log bucket</span>
<span class="w">    </span><span class="nx">NagSuppressions</span><span class="p">.</span><span class="nx">addResourceSuppressionsByPath</span><span class="p">(</span><span class="nx">stack</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="sb">`/</span><span class="si">${</span><span class="nx">stack</span><span class="p">.</span><span class="nx">stackName</span><span class="si">}</span><span class="sb">/Api/AccessLogBucket`</span><span class="p">,</span>
<span class="w">    </span><span class="p">],</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;AwsSolutions-S1&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Dont need access logs for access log bucket&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;AwsSolutions-IAM5&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Allow resource:*&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">appliesTo</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;Resource::*&#39;</span><span class="p">]</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">]);</span>

<span class="w">    </span><span class="nx">NagSuppressions</span><span class="p">.</span><span class="nx">addResourceSuppressionsByPath</span><span class="p">(</span><span class="nx">stack</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="sb">`/</span><span class="si">${</span><span class="nx">stack</span><span class="p">.</span><span class="nx">stackName</span><span class="si">}</span><span class="sb">/Api/Canary/ServiceRole`</span><span class="p">,</span>
<span class="w">    </span><span class="p">],</span><span class="w"> </span><span class="p">[{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;AwsSolutions-IAM5&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Allow resource:*&#39;</span><span class="w"> </span><span class="p">}]);</span>

<span class="w">    </span><span class="nx">NagSuppressions</span><span class="p">.</span><span class="nx">addResourceSuppressionsByPath</span><span class="p">(</span><span class="nx">stack</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="sb">`/</span><span class="si">${</span><span class="nx">stack</span><span class="p">.</span><span class="nx">stackName</span><span class="si">}</span><span class="sb">/Api/CanaryArtifactsBucket`</span><span class="p">,</span>
<span class="w">    </span><span class="p">],</span><span class="w"> </span><span class="p">[{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;AwsSolutions-S1&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Dont need access logs for canary bucket&#39;</span><span class="w"> </span><span class="p">}]);</span>

<span class="w">    </span><span class="nx">NagSuppressions</span><span class="p">.</span><span class="nx">addResourceSuppressionsByPath</span><span class="p">(</span><span class="nx">stack</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="sb">`/</span><span class="si">${</span><span class="nx">stack</span><span class="p">.</span><span class="nx">stackName</span><span class="si">}</span><span class="sb">/Api/DeploymentGroup/ServiceRole`</span><span class="p">,</span>
<span class="w">    </span><span class="p">],</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;AwsSolutions-IAM4&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Allow AWSCodeDeployRoleForECS policy&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">appliesTo</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;Policy::arn:&lt;AWS::Partition&gt;:iam::aws:policy/AWSCodeDeployRoleForECS&#39;</span><span class="p">]</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">]);</span>

<span class="w">    </span><span class="nx">NagSuppressions</span><span class="p">.</span><span class="nx">addResourceSuppressionsByPath</span><span class="p">(</span><span class="nx">stack</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="sb">`/</span><span class="si">${</span><span class="nx">stack</span><span class="p">.</span><span class="nx">stackName</span><span class="si">}</span><span class="sb">/Api/DeploymentGroup/Deployment`</span><span class="p">,</span>
<span class="w">    </span><span class="p">],</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;AwsSolutions-IAM4&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Allow AWSLambdaBasicExecutionRole policy&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">appliesTo</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;Policy::arn:&lt;AWS::Partition&gt;:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole&#39;</span><span class="p">],</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">],</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>

<span class="w">    </span><span class="nx">NagSuppressions</span><span class="p">.</span><span class="nx">addResourceSuppressionsByPath</span><span class="p">(</span><span class="nx">stack</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="sb">`/</span><span class="si">${</span><span class="nx">stack</span><span class="p">.</span><span class="nx">stackName</span><span class="si">}</span><span class="sb">/Api/TaskDef`</span><span class="p">,</span>
<span class="w">    </span><span class="p">],</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;AwsSolutions-ECS2&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Allow environment variables for configuration of values that are not confidential&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">]);</span>

<span class="w">    </span><span class="nx">NagSuppressions</span><span class="p">.</span><span class="nx">addResourceSuppressionsByPath</span><span class="p">(</span><span class="nx">stack</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="sb">`/</span><span class="si">${</span><span class="nx">stack</span><span class="p">.</span><span class="nx">stackName</span><span class="si">}</span><span class="sb">/Api/LB/SecurityGroup`</span><span class="p">,</span>
<span class="w">    </span><span class="p">],</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;AwsSolutions-EC23&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Allow public inbound access on ELB&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">]);</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">test</span><span class="p">(</span><span class="s1">&#39;Snapshot&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">template</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Template</span><span class="p">.</span><span class="nx">fromStack</span><span class="p">(</span><span class="nx">stack</span><span class="p">);</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">template</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()).</span><span class="nx">toMatchSnapshot</span><span class="p">();</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">test</span><span class="p">(</span><span class="s1">&#39;cdk-nag AwsSolutions Pack errors&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">errors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Annotations</span><span class="p">.</span><span class="nx">fromStack</span><span class="p">(</span><span class="nx">stack</span><span class="p">).</span><span class="nx">findError</span><span class="p">(</span>
<span class="w">      </span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">Match</span><span class="p">.</span><span class="nx">stringLikeRegexp</span><span class="p">(</span><span class="s1">&#39;AwsSolutions-.*&#39;</span><span class="p">),</span>
<span class="w">    </span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">synthesisMessageToString</span><span class="p">);</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">errors</span><span class="p">).</span><span class="nx">toHaveLength</span><span class="p">(</span><span class="mf">0</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">test</span><span class="p">(</span><span class="s1">&#39;cdk-nag AwsSolutions Pack warnings&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">warnings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Annotations</span><span class="p">.</span><span class="nx">fromStack</span><span class="p">(</span><span class="nx">stack</span><span class="p">).</span><span class="nx">findWarning</span><span class="p">(</span>
<span class="w">      </span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">Match</span><span class="p">.</span><span class="nx">stringLikeRegexp</span><span class="p">(</span><span class="s1">&#39;AwsSolutions-.*&#39;</span><span class="p">),</span>
<span class="w">    </span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">synthesisMessageToString</span><span class="p">);</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">warnings</span><span class="p">).</span><span class="nx">toHaveLength</span><span class="p">(</span><span class="mf">0</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;Deployment without AppConfig&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">stack</span><span class="o">:</span><span class="w"> </span><span class="kt">DeploymentStack</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">app</span><span class="o">:</span><span class="w"> </span><span class="kt">App</span><span class="p">;</span>

<span class="w">  </span><span class="nx">beforeAll</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">appName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;fruit-api&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">environmentName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;unit-test&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">App</span><span class="p">({</span><span class="w"> </span><span class="nx">context</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">appName</span><span class="p">,</span><span class="w"> </span><span class="nx">environmentName</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="nx">stack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">DeploymentStack</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;TestStack&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">env</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">account</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;dummy&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">region</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;us-east-1&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">test</span><span class="p">(</span><span class="s1">&#39;Snapshot&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">template</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Template</span><span class="p">.</span><span class="nx">fromStack</span><span class="p">(</span><span class="nx">stack</span><span class="p">);</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">template</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()).</span><span class="nx">toMatchSnapshot</span><span class="p">();</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="nx">test</span><span class="p">(</span><span class="s1">&#39;taskdef&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">template</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Template</span><span class="p">.</span><span class="nx">fromStack</span><span class="p">(</span><span class="nx">stack</span><span class="p">);</span>
<span class="w">    </span><span class="nx">template</span><span class="p">.</span><span class="nx">hasResourceProperties</span><span class="p">(</span><span class="s1">&#39;AWS::ECS::TaskDefinition&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">ContainerDefinitions</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="nx">Environment</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">            </span><span class="nx">Name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;SPRING_DATASOURCE_URL&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">Name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;APPCONFIG_AGENT_APPLICATION&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">Name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;APPCONFIG_AGENT_ENVIRONMENT&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">Value</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;unit-test&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">Name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;APPCONFIG_AGENT_ENABLED&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">Value</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;false&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="p">}],</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">      </span><span class="p">],</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;Deployment with AppConfig&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">stack</span><span class="o">:</span><span class="w"> </span><span class="kt">DeploymentStack</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">app</span><span class="o">:</span><span class="w"> </span><span class="kt">App</span><span class="p">;</span>

<span class="w">  </span><span class="nx">beforeAll</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">appName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;fruit-api&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">workloadName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;food&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">environmentName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;unit-test&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">App</span><span class="p">({</span><span class="w"> </span><span class="nx">context</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">appName</span><span class="p">,</span><span class="w"> </span><span class="nx">environmentName</span><span class="p">,</span><span class="w"> </span><span class="nx">workloadName</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="nx">stack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">DeploymentStack</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;TestStack&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">appConfigRoleArn</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;dummy-role-arn&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">env</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">account</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;dummy&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">region</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;us-east-1&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">test</span><span class="p">(</span><span class="s1">&#39;Snapshot&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">template</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Template</span><span class="p">.</span><span class="nx">fromStack</span><span class="p">(</span><span class="nx">stack</span><span class="p">);</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">template</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()).</span><span class="nx">toMatchSnapshot</span><span class="p">();</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="nx">test</span><span class="p">(</span><span class="s1">&#39;taskdef&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">template</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Template</span><span class="p">.</span><span class="nx">fromStack</span><span class="p">(</span><span class="nx">stack</span><span class="p">);</span>
<span class="w">    </span><span class="nx">template</span><span class="p">.</span><span class="nx">hasResourceProperties</span><span class="p">(</span><span class="s1">&#39;AWS::ECS::TaskDefinition&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">ContainerDefinitions</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="nx">Environment</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">            </span><span class="nx">Name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;SPRING_DATASOURCE_URL&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">Name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;APPCONFIG_AGENT_APPLICATION&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">Value</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;food&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">Name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;APPCONFIG_AGENT_ENVIRONMENT&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">Value</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;unit-test&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">Name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;APPCONFIG_AGENT_ENABLED&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">Value</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="p">}],</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="nx">Environment</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">            </span><span class="nx">Name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;SERVICE_REGION&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">Value</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;us-east-1&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">Name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ROLE_ARN&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">Value</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;dummy-role-arn&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">Name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ROLE_SESSION_NAME&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">Name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;LOG_LEVEL&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">Value</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;info&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="p">}],</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">      </span><span class="p">],</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
</details>
<details class="required" open="open">
<summary>Secrets Detection</summary>
<p><a href="https://aquasecurity.github.io/trivy">Trivy</a> is used to scan the source for secrets. The <a href="https://github.com/marketplace/actions/aqua-security-trivy">Trivy GitHub Action</a> is used in the Amazon CodeCatalyst workflow to perform the scan:</p>
<div class="highlight"><pre><span></span><code><span class="nt">SCA</span><span class="p">:</span>
<span class="w">    </span><span class="nt">Identifier</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws/github-actions-runner@v1</span>
<span class="w">    </span><span class="nt">Inputs</span><span class="p">:</span>
<span class="w">      </span><span class="nt">Sources</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">WorkflowSource</span>
<span class="w">    </span><span class="nt">Configuration</span><span class="p">:</span>
<span class="w">      </span><span class="nt">Steps</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Trivy Vulnerability Scanner</span>
<span class="w">          </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aquasecurity/trivy-action@master</span>
<span class="w">          </span><span class="nt">with</span><span class="p">:</span>
<span class="w">            </span><span class="nt">scan-type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fs</span>
<span class="w">            </span><span class="nt">ignore-unfixed</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">            </span><span class="nt">format</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cyclonedx</span>
<span class="w">            </span><span class="nt">output</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sbom.json</span>
<span class="w">            </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CRITICAL,HIGH</span>
<span class="w">            </span><span class="nt">security-checks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vuln,config,secret</span>
</code></pre></div>
</details>
<details class="required" open="open">
<summary>Static Application Security Testing (SAST)</summary>
<p>The <a href="https://spotbugs.github.io/">SpotBugs</a> Maven plugin is used along with the <a href="https://find-sec-bugs.github.io/">Find Security Bugs</a> plugin to identify OWASP Top 10 and CWE vulnerabilities in the application source code.</p>
</details>
<details class="required" open="open">
<summary>Package and Store Artifact(s)</summary>
<p><a href="https://aws.amazon.com/cdk/">AWS Cloud Development Kit</a> handles the packaging and storing of assets during the <code>Synth</code> action and <code>Assets</code> stage. The <code>Synth</code> action generates the CloudFormation templates to be deployed into the subsequent environments along with staging up the files necessary to create a docker image. The <code>Assets</code> stage then performs the docker build step to create a new image and push the image to <a href="https://aws.amazon.com/ecr/">Amazon ECR</a> repositories in each environment account.</p>
<p><img alt="" src="../assets/codecatalyst-build-package.png" /></p>
</details>
<details class="required" open="open">
<summary>Software Composition Analysis (SCA)</summary>
<p><a href="https://aquasecurity.github.io/trivy">Trivy</a> is used to scan the source for vulnerabilities in its dependencies. The <code>pom.xml</code> and <code>Dockerfile</code> files are scanned for configuration issues or vulnerabilities in any dependencies. The scanning is accomplished by a CDK construct that creates a CodeBuild job to run <code>trivy</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nt">SCA</span><span class="p">:</span>
<span class="w">    </span><span class="nt">Identifier</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws/github-actions-runner@v1</span>
<span class="w">    </span><span class="nt">Inputs</span><span class="p">:</span>
<span class="w">      </span><span class="nt">Sources</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">WorkflowSource</span>
<span class="w">    </span><span class="nt">Configuration</span><span class="p">:</span>
<span class="w">      </span><span class="nt">Steps</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Trivy Vulnerability Scanner</span>
<span class="w">          </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aquasecurity/trivy-action@master</span>
<span class="w">          </span><span class="nt">with</span><span class="p">:</span>
<span class="w">            </span><span class="nt">scan-type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fs</span>
<span class="w">            </span><span class="nt">ignore-unfixed</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">            </span><span class="nt">format</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cyclonedx</span>
<span class="w">            </span><span class="nt">output</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sbom.json</span>
<span class="w">            </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CRITICAL,HIGH</span>
<span class="w">            </span><span class="nt">security-checks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vuln,config,secret</span>
</code></pre></div>
<p>Trivy is also used within the <code>Dockerfile</code> to scan the image after it is built. The <code>docker build</code> will fail if Trivy finds any vulnerabilities in the final image:</p>
<div class="highlight"><pre><span></span><code><span class="k">FROM</span><span class="w"> </span><span class="s">public.ecr.aws/amazoncorretto/amazoncorretto:17-al2022-jdk</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">build</span>
<span class="k">USER</span><span class="w"> </span><span class="s">nobody</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>
<span class="k">COPY</span><span class="w"> </span>target/fruit-api.jar<span class="w"> </span>/app
<span class="k">HEALTHCHECK</span><span class="w"> </span>--interval<span class="o">=</span>30s<span class="w"> </span>--timeout<span class="o">=</span>5s<span class="w"> </span>--start-period<span class="o">=</span>30s<span class="w"> </span>--retries<span class="o">=</span><span class="m">3</span><span class="w"> </span>CMD<span class="w"> </span>/bin/curl<span class="w"> </span>--fail<span class="w"> </span>--silent<span class="w"> </span>localhost:8080/actuator/health<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>UP<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">ENTRYPOINT</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;java&quot;</span><span class="p">,</span><span class="s2">&quot;-jar&quot;</span><span class="p">,</span><span class="s2">&quot;/app/fruit-api.jar&quot;</span><span class="p">]</span>

<span class="c"># Use multi-stage builds to scan newly created image with Trivy. This second stage &#39;vulnscan&#39;</span>
<span class="c"># isn&#39;t published to Amazon ECR and is never run. It is only used to run the Trivy scan</span>
<span class="c"># against the newly created image in the &#39;build&#39; stage.</span>
<span class="c">#</span>
<span class="c"># This stage must run as root so Trivy can scan all files in the image, not just</span>
<span class="c"># those accessible by the nobody user. The user is switched back to &#39;nobody&#39; at</span>
<span class="c"># the end to ensure that even if this image is used for something it is done</span>
<span class="c"># without the &#39;root&#39; user.</span>

<span class="k">FROM</span><span class="w"> </span><span class="s">build</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s">vulnscan</span>
<span class="k">USER</span><span class="w"> </span><span class="s">root</span>
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>aquasec/trivy:latest<span class="w"> </span>/usr/local/bin/trivy<span class="w"> </span>/usr/local/bin/trivy
<span class="k">RUN</span><span class="w"> </span>trivy<span class="w"> </span>filesystem<span class="w"> </span>--exit-code<span class="w"> </span><span class="m">1</span><span class="w"> </span>--no-progress<span class="w"> </span>--ignore-unfixed<span class="w"> </span>-s<span class="w"> </span>CRITICAL<span class="w"> </span>/
<span class="k">USER</span><span class="w"> </span><span class="s">nobody</span>
</code></pre></div>
</details>
<details class="required" open="open">
<summary>Software Bill of Materials (SBOM)</summary>
<p>Trivy generates an SBOM in the form of a <a href="https://cyclonedx.org/">CycloneDX</a> JSON report. The SBOM is saved as a CodeCatalyst asset.  Trivy supports additional SBOM formats such as <a href="https://spdx.dev/wp-content/uploads/sites/41/2020/08/SPDX-specification-2-2.pdf">SPDX</a>, and <a href="https://docs.oasis-open.org/sarif/sarif/v2.0/sarif-v2.0.html">SARIF</a>.</p>
</details>
<h2 id="test-beta">Test (Beta)<a class="headerlink" href="#test-beta" title="Permanent link">&para;</a></h2>
<details class="required" open="open">
<summary>Launch Environment</summary>
<p><img alt="Deployment" src="../assets/ri-codecatalyst-pipeline-deployment.png" /></p>
<p>The infrastructure for each environment is defined in <a href="https://aws.amazon.com/cdk/">AWS Cloud Development Kit</a>:</p>
<div class="highlight"><pre><span></span><code><span class="k">super</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">props</span><span class="p">);</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">AssetImage</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;build&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">appName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Stack</span><span class="p">.</span><span class="k">of</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="nx">stackName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
<span class="w">  </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sb">`-</span><span class="si">${</span><span class="nx">Stack</span><span class="p">.</span><span class="k">of</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">region</span><span class="si">}</span><span class="sb">-`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;-&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">vpc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ec2</span><span class="p">.</span><span class="nx">Vpc</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Vpc&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">maxAzs</span><span class="o">:</span><span class="w"> </span><span class="kt">3</span><span class="p">,</span>
<span class="w">  </span><span class="nx">natGateways</span><span class="o">:</span><span class="w"> </span><span class="kt">props?.natGateways</span><span class="p">,</span>
<span class="p">});</span>
<span class="ow">new</span><span class="w"> </span><span class="nx">FlowLog</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;VpcFlowLog&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">resourceType</span><span class="o">:</span><span class="w"> </span><span class="kt">FlowLogResourceType.fromVpc</span><span class="p">(</span><span class="nx">vpc</span><span class="p">),</span>
<span class="p">});</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">dbName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;fruits&#39;</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">dbSecret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">DatabaseSecret</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;AuroraSecret&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;fruitapi&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">secretName</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">appName</span><span class="si">}</span><span class="sb">-DB`</span><span class="p">,</span>
<span class="p">});</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">DatabaseCluster</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Database&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">engine</span><span class="o">:</span><span class="w"> </span><span class="kt">DatabaseClusterEngine.auroraMysql</span><span class="p">({</span>
<span class="w">    </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="kt">AuroraMysqlEngineVersion.VER_3_07_1</span><span class="p">,</span>
<span class="w">  </span><span class="p">}),</span>
<span class="w">  </span><span class="nx">credentials</span><span class="o">:</span><span class="w"> </span><span class="kt">Credentials.fromSecret</span><span class="p">(</span><span class="nx">dbSecret</span><span class="p">),</span>
<span class="w">  </span><span class="nx">writer</span><span class="o">:</span><span class="w"> </span><span class="kt">ClusterInstance.serverlessV2</span><span class="p">(</span><span class="s1">&#39;writer&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="nx">defaultDatabaseName</span><span class="o">:</span><span class="w"> </span><span class="kt">dbName</span><span class="p">,</span>
<span class="w">  </span><span class="nx">serverlessV2MaxCapacity</span><span class="o">:</span><span class="w"> </span><span class="kt">2</span><span class="p">,</span>
<span class="w">  </span><span class="nx">serverlessV2MinCapacity</span><span class="o">:</span><span class="w"> </span><span class="kt">0.5</span><span class="p">,</span>
<span class="w">  </span><span class="nx">vpc</span><span class="p">,</span>
<span class="w">  </span><span class="nx">clusterIdentifier</span><span class="o">:</span><span class="w"> </span><span class="kt">appName</span><span class="p">,</span>
<span class="w">  </span><span class="nx">storageEncrypted</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="p">});</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">cluster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ecs</span><span class="p">.</span><span class="nx">Cluster</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Cluster&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">vpc</span><span class="p">,</span>
<span class="w">  </span><span class="nx">containerInsights</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="w">  </span><span class="nx">clusterName</span><span class="o">:</span><span class="w"> </span><span class="kt">appName</span><span class="p">,</span>
<span class="p">});</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">appLogGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">LogGroup</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;AppLogGroup&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">retention</span><span class="o">:</span><span class="w"> </span><span class="kt">RetentionDays.ONE_WEEK</span><span class="p">,</span>
<span class="w">  </span><span class="nx">logGroupName</span><span class="o">:</span><span class="w"> </span><span class="sb">`/aws/ecs/service/</span><span class="si">${</span><span class="nx">appName</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">  </span><span class="nx">removalPolicy</span><span class="o">:</span><span class="w"> </span><span class="kt">RemovalPolicy.DESTROY</span><span class="p">,</span>
<span class="p">});</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">deploymentConfig</span><span class="o">:</span><span class="w"> </span><span class="kt">IEcsDeploymentConfig</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">props</span><span class="o">?</span><span class="p">.</span><span class="nx">deploymentConfigName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">deploymentConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">EcsDeploymentConfig</span><span class="p">.</span><span class="nx">fromEcsDeploymentConfigName</span><span class="p">(</span>
<span class="w">    </span><span class="k">this</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;DeploymentConfig&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">props</span><span class="p">.</span><span class="nx">deploymentConfigName</span><span class="p">,</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">appConfigEnabled</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="nx">props</span><span class="o">?</span><span class="p">.</span><span class="nx">appConfigRoleArn</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">  </span><span class="nx">props</span><span class="p">.</span><span class="nx">appConfigRoleArn</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ApplicationLoadBalancedCodeDeployedFargateService</span><span class="p">(</span>
<span class="w">  </span><span class="k">this</span><span class="p">,</span>
<span class="w">  </span><span class="s1">&#39;Api&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nx">cluster</span><span class="p">,</span>
<span class="w">    </span><span class="nx">capacityProviderStrategies</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">capacityProvider</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;FARGATE_SPOT&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">weight</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nx">minHealthyPercent</span><span class="o">:</span><span class="w"> </span><span class="kt">50</span><span class="p">,</span>
<span class="w">    </span><span class="nx">maxHealthyPercent</span><span class="o">:</span><span class="w"> </span><span class="kt">200</span><span class="p">,</span>
<span class="w">    </span><span class="nx">desiredCount</span><span class="o">:</span><span class="w"> </span><span class="kt">3</span><span class="p">,</span>
<span class="w">    </span><span class="nx">cpu</span><span class="o">:</span><span class="w"> </span><span class="kt">512</span><span class="p">,</span>
<span class="w">    </span><span class="nx">memoryLimitMiB</span><span class="o">:</span><span class="w"> </span><span class="kt">1024</span><span class="p">,</span>
<span class="w">    </span><span class="nx">taskImageOptions</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">image</span><span class="p">,</span>
<span class="w">      </span><span class="nx">containerName</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">containerPort</span><span class="o">:</span><span class="w"> </span><span class="kt">8080</span><span class="p">,</span>
<span class="w">      </span><span class="nx">family</span><span class="o">:</span><span class="w"> </span><span class="kt">appName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">logDriver</span><span class="o">:</span><span class="w"> </span><span class="kt">AwsLogDriver.awsLogs</span><span class="p">({</span>
<span class="w">        </span><span class="nx">logGroup</span><span class="o">:</span><span class="w"> </span><span class="kt">appLogGroup</span><span class="p">,</span>
<span class="w">        </span><span class="nx">streamPrefix</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;service&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">}),</span>
<span class="w">      </span><span class="nx">secrets</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">SPRING_DATASOURCE_USERNAME</span><span class="o">:</span><span class="w"> </span><span class="kt">Secret.fromSecretsManager</span><span class="p">(</span>
<span class="w">          </span><span class="nx">dbSecret</span><span class="p">,</span>
<span class="w">          </span><span class="s1">&#39;username&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="p">),</span>
<span class="w">        </span><span class="nx">SPRING_DATASOURCE_PASSWORD</span><span class="o">:</span><span class="w"> </span><span class="kt">Secret.fromSecretsManager</span><span class="p">(</span>
<span class="w">          </span><span class="nx">dbSecret</span><span class="p">,</span>
<span class="w">          </span><span class="s1">&#39;password&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="p">),</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">environment</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">SPRING_DATASOURCE_URL</span><span class="o">:</span><span class="w"> </span><span class="sb">`jdbc:mysql://</span><span class="si">${</span><span class="nx">db</span><span class="p">.</span><span class="nx">clusterEndpoint</span><span class="p">.</span><span class="nx">hostname</span><span class="si">}</span><span class="sb">:</span><span class="si">${</span><span class="nx">db</span><span class="p">.</span><span class="nx">clusterEndpoint</span><span class="p">.</span><span class="nx">port</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">dbName</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">        </span><span class="nx">APPCONFIG_AGENT_APPLICATION</span><span class="o">:</span>
<span class="w">          </span><span class="kt">this.node.tryGetContext</span><span class="p">(</span><span class="s1">&#39;workloadName&#39;</span><span class="p">),</span>
<span class="w">        </span><span class="nx">APPCONFIG_AGENT_ENVIRONMENT</span><span class="o">:</span>
<span class="w">          </span><span class="kt">this.node.tryGetContext</span><span class="p">(</span><span class="s1">&#39;environmentName&#39;</span><span class="p">),</span>
<span class="w">        </span><span class="nx">APPCONFIG_AGENT_ENABLED</span><span class="o">:</span><span class="w"> </span><span class="kt">appConfigEnabled.toString</span><span class="p">(),</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">deregistrationDelay</span><span class="o">:</span><span class="w"> </span><span class="kt">Duration.seconds</span><span class="p">(</span><span class="mf">5</span><span class="p">),</span>
<span class="w">    </span><span class="nx">responseTimeAlarmThreshold</span><span class="o">:</span><span class="w"> </span><span class="kt">Duration.seconds</span><span class="p">(</span><span class="mf">3</span><span class="p">),</span>
<span class="w">    </span><span class="nx">targetHealthCheck</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">healthyThresholdCount</span><span class="o">:</span><span class="w"> </span><span class="kt">2</span><span class="p">,</span>
<span class="w">      </span><span class="nx">unhealthyThresholdCount</span><span class="o">:</span><span class="w"> </span><span class="kt">2</span><span class="p">,</span>
<span class="w">      </span><span class="nx">interval</span><span class="o">:</span><span class="w"> </span><span class="kt">Duration.seconds</span><span class="p">(</span><span class="mf">60</span><span class="p">),</span>
<span class="w">      </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/actuator/health&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">deploymentConfig</span><span class="p">,</span>
<span class="w">    </span><span class="nx">terminationWaitTime</span><span class="o">:</span><span class="w"> </span><span class="kt">Duration.minutes</span><span class="p">(</span><span class="mf">5</span><span class="p">),</span>
<span class="w">    </span><span class="nx">apiCanaryTimeout</span><span class="o">:</span><span class="w"> </span><span class="kt">Duration.seconds</span><span class="p">(</span><span class="mf">5</span><span class="p">),</span>
<span class="w">    </span><span class="nx">apiTestSteps</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;getAll&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/api/fruits&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">jmesPath</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;length(@)&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">expectedValue</span><span class="o">:</span><span class="w"> </span><span class="kt">5</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">);</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">appConfigEnabled</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">service</span><span class="p">.</span><span class="nx">taskDefinition</span><span class="p">.</span><span class="nx">addContainer</span><span class="p">(</span><span class="s1">&#39;appconfig-agent&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">image</span><span class="o">:</span><span class="w"> </span><span class="kt">ecs.ContainerImage.fromRegistry</span><span class="p">(</span>
<span class="w">      </span><span class="s1">&#39;public.ecr.aws/aws-appconfig/aws-appconfig-agent:2.x&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">),</span>
<span class="w">    </span><span class="nx">essential</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span>
<span class="w">    </span><span class="nx">logging</span><span class="o">:</span><span class="w"> </span><span class="kt">AwsLogDriver.awsLogs</span><span class="p">({</span>
<span class="w">      </span><span class="nx">logGroup</span><span class="o">:</span><span class="w"> </span><span class="kt">appLogGroup</span><span class="p">,</span>
<span class="w">      </span><span class="nx">streamPrefix</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;service&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">}),</span>
<span class="w">    </span><span class="nx">environment</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">SERVICE_REGION</span><span class="o">:</span><span class="w"> </span><span class="kt">this.region</span><span class="p">,</span>
<span class="w">      </span><span class="nx">ROLE_ARN</span><span class="o">:</span><span class="w"> </span><span class="kt">props</span><span class="o">!</span><span class="p">.</span><span class="nx">appConfigRoleArn</span><span class="o">!</span><span class="p">,</span>
<span class="w">      </span><span class="nx">ROLE_SESSION_NAME</span><span class="o">:</span><span class="w"> </span><span class="kt">appName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">LOG_LEVEL</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;info&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">portMappings</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span><span class="w"> </span><span class="nx">containerPort</span><span class="o">:</span><span class="w"> </span><span class="kt">2772</span><span class="w"> </span><span class="p">}],</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">service</span><span class="p">.</span><span class="nx">taskDefinition</span><span class="p">.</span><span class="nx">addToTaskRolePolicy</span><span class="p">(</span>
<span class="w">    </span><span class="ow">new</span><span class="w"> </span><span class="nx">PolicyStatement</span><span class="p">({</span>
<span class="w">      </span><span class="nx">actions</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;sts:AssumeRole&#39;</span><span class="p">],</span>
<span class="w">      </span><span class="nx">resources</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nx">props</span><span class="o">!</span><span class="p">.</span><span class="nx">appConfigRoleArn</span><span class="o">!</span><span class="p">],</span>
<span class="w">    </span><span class="p">}),</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">service</span><span class="p">.</span><span class="nx">service</span><span class="p">.</span><span class="nx">connections</span><span class="p">.</span><span class="nx">allowTo</span><span class="p">(</span>
<span class="w">  </span><span class="nx">db</span><span class="p">,</span>
<span class="w">  </span><span class="nx">ec2</span><span class="p">.</span><span class="nx">Port</span><span class="p">.</span><span class="nx">tcp</span><span class="p">(</span><span class="nx">db</span><span class="p">.</span><span class="nx">clusterEndpoint</span><span class="p">.</span><span class="nx">port</span><span class="p">),</span>
<span class="p">);</span>

<span class="k">this</span><span class="p">.</span><span class="nx">apiUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">CfnOutput</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;endpointUrl&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="sb">`http://</span><span class="si">${</span><span class="nx">service</span><span class="p">.</span><span class="nx">listener</span><span class="p">.</span><span class="nx">loadBalancer</span><span class="p">.</span><span class="nx">loadBalancerDnsName</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="p">});</span>
</code></pre></div>
<p>The CDK deployment is then performed for each environment:</p>
<div class="highlight"><pre><span></span><code><span class="nt">Deploy</span><span class="p">:</span>
<span class="w">    </span><span class="nt">Identifier</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws/cdk-deploy@v1</span>
<span class="w">    </span><span class="nt">DependsOn</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Build</span>
<span class="w">    </span><span class="nt">Inputs</span><span class="p">:</span>
<span class="w">      </span><span class="nt">Artifacts</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">package</span>
<span class="w">    </span><span class="nt">Environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Beta</span>
<span class="w">      </span><span class="nt">Connections</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">beta</span>
<span class="w">          </span><span class="nt">Role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">codecatalyst</span>
<span class="w">    </span><span class="nt">Configuration</span><span class="p">:</span>
<span class="w">      </span><span class="nt">StackName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit-api</span>
<span class="w">      </span><span class="nt">Region</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">us-west-2</span>
<span class="w">      </span><span class="nt">Context</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{&quot;deploymentConfigurationName&quot;:&quot;CodeDeployDefault.ECSCanary10Percent5Minutes&quot;}&#39;</span>
<span class="w">      </span><span class="nt">CfnOutputVariables</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;[&quot;endpointUrl&quot;]&#39;</span>
</code></pre></div>
</details>
<details class="required" open="open">
<summary>Database Deploy</summary>
<p>Spring Boot is configured to run <a href="https://www.liquibase.org/">Liquibase</a> on startup. This reads the configuration in <code>src/main/resources/db/changelog/db.changelog-master.yml</code> to define the tables and initial data for the database:</p>
<div class="highlight"><pre><span></span><code><span class="nt">databaseChangeLog</span><span class="p">:</span>
<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">changeSet</span><span class="p">:</span>
<span class="w">       </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">       </span><span class="nt">author</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS</span>
<span class="w">       </span><span class="nt">changes</span><span class="p">:</span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">createTable</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">id</span>
<span class="w">               </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bigint</span>
<span class="w">               </span><span class="nt">autoIncrement</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">               </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">                   </span><span class="nt">primaryKey</span><span class="p">:</span><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">                   </span><span class="nt">nullable</span><span class="p">:</span><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span>
<span class="w">               </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">varchar(250)</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">insert</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Apple</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">insert</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Orange</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">insert</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Banana</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">insert</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Cherry</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">insert</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Grape</span>

<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">changeSet</span><span class="p">:</span>
<span class="w">       </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2&quot;</span>
<span class="w">       </span><span class="nt">author</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS</span>
<span class="w">       </span><span class="nt">changes</span><span class="p">:</span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">addColumn</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">classification</span>
<span class="w">               </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">varchar(250)</span>
<span class="w">               </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">                 </span><span class="nt">nullable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">update</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">classification</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pome</span>
<span class="w">           </span><span class="nt">where</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name=&#39;Apple&#39;</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">update</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">classification</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">berry</span>
<span class="w">           </span><span class="nt">where</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name=&#39;Orange&#39;</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">update</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">classification</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">berry</span>
<span class="w">           </span><span class="nt">where</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name=&#39;Banana&#39;</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">update</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">classification</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">drupe</span>
<span class="w">           </span><span class="nt">where</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name=&#39;Cherry&#39;</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">update</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">classification</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">berry</span>
<span class="w">           </span><span class="nt">where</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name=&#39;Grape&#39;</span>
</code></pre></div>
</details>
<details class="required" open="open">
<summary>Deploy Software</summary>
<p>The <em>Launch Environment</em> action above creates a new <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definitions.html">Amazon ECS Task Definition</a> for the new docker image and then updates the Amazon ECS Service to use the new Task Definition.</p>
</details>
<details class="required" open="open">
<summary>Integration Tests</summary>
<p>Integration tests are preformed during the <em>Build Source</em> action. They are defined with <a href="https://www.soapui.org/">SoapUI</a> in <code>fruit-api-soapui-project.xml</code>. They are executed by <a href="https://maven.apache.org/">Maven</a> in the <code>integration-test</code> phase using plugins in <code>pom.xml</code>.  Spring Boot is configure to start a local instance of the application with an H2 database during the <code>pre-integration-test</code> phase and then to terminate on the <code>post-integration-test</code> phase.  The results of the unit tests are uploaded to Amazon CodeCatalyst to track over time.</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;plugins&gt;</span>
<span class="w">    </span><span class="nt">&lt;plugin&gt;</span>
<span class="w">        </span><span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
<span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">        </span><span class="nt">&lt;executions&gt;</span>
<span class="w">            </span><span class="nt">&lt;execution&gt;</span>
<span class="w">                </span><span class="nt">&lt;id&gt;</span>pre-integration-test<span class="nt">&lt;/id&gt;</span>
<span class="w">                </span><span class="nt">&lt;goals&gt;</span>
<span class="w">                    </span><span class="nt">&lt;goal&gt;</span>start<span class="nt">&lt;/goal&gt;</span>
<span class="w">                </span><span class="nt">&lt;/goals&gt;</span>
<span class="w">            </span><span class="nt">&lt;/execution&gt;</span>
<span class="w">            </span><span class="nt">&lt;execution&gt;</span>
<span class="w">                </span><span class="nt">&lt;id&gt;</span>post-integration-test<span class="nt">&lt;/id&gt;</span>
<span class="w">                </span><span class="nt">&lt;goals&gt;</span>
<span class="w">                    </span><span class="nt">&lt;goal&gt;</span>stop<span class="nt">&lt;/goal&gt;</span>
<span class="w">                </span><span class="nt">&lt;/goals&gt;</span>
<span class="w">            </span><span class="nt">&lt;/execution&gt;</span>
<span class="w">        </span><span class="nt">&lt;/executions&gt;</span>
<span class="w">    </span><span class="nt">&lt;/plugin&gt;</span>
<span class="w">    </span><span class="nt">&lt;plugin&gt;</span>
<span class="w">        </span><span class="nt">&lt;groupId&gt;</span>com.smartbear.soapui<span class="nt">&lt;/groupId&gt;</span>
<span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>soapui-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">        </span><span class="nt">&lt;version&gt;</span>5.7.0<span class="nt">&lt;/version&gt;</span>
<span class="w">        </span><span class="nt">&lt;configuration&gt;</span>
<span class="w">            </span><span class="nt">&lt;junitReport&gt;</span>true<span class="nt">&lt;/junitReport&gt;</span>
<span class="w">            </span><span class="nt">&lt;outputFolder&gt;</span>target/soapui-reports<span class="nt">&lt;/outputFolder&gt;</span>
<span class="w">            </span><span class="nt">&lt;endpoint&gt;</span>${soapui.endpoint}<span class="nt">&lt;/endpoint&gt;</span>
<span class="w">        </span><span class="nt">&lt;/configuration&gt;</span>
<span class="w">        </span><span class="nt">&lt;executions&gt;</span>
<span class="w">            </span><span class="nt">&lt;execution&gt;</span>
<span class="w">                </span><span class="nt">&lt;phase&gt;</span>integration-test<span class="nt">&lt;/phase&gt;</span>
<span class="w">                </span><span class="nt">&lt;goals&gt;</span>
<span class="w">                    </span><span class="nt">&lt;goal&gt;</span>test<span class="nt">&lt;/goal&gt;</span>
<span class="w">                </span><span class="nt">&lt;/goals&gt;</span>
<span class="w">            </span><span class="nt">&lt;/execution&gt;</span>
<span class="w">        </span><span class="nt">&lt;/executions&gt;</span>
<span class="w">    </span><span class="nt">&lt;/plugin&gt;</span>
<span class="nt">&lt;/plugins&gt;</span>
</code></pre></div>
</details>
<details class="required" open="open">
<summary>Acceptance Tests</summary>
<p>Acceptance tests are preformed after the <em>Launch Environment</em> and <em>Deploy Software</em> actions:</p>
<p><img alt="" src="../assets/codecatalyst-deploy-beta.png" /></p>
<p>The tests are defined with <a href="https://www.soapui.org/">SoapUI</a> in <code>fruit-api-soapui-project.xml</code>. They are executed by <a href="https://maven.apache.org/">Maven</a> with the endpoint overridden to the URL from the CloudFormation output. An action is added to the CodeCatalyst workflow to run SoapUI:</p>
<div class="highlight"><pre><span></span><code><span class="nt">Test</span><span class="p">:</span>
<span class="w">    </span><span class="nt">Identifier</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws/managed-test@v1</span>
<span class="w">    </span><span class="nt">Inputs</span><span class="p">:</span>
<span class="w">      </span><span class="nt">Artifacts</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">package</span>
<span class="w">      </span><span class="nt">Variables</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">endpointUrl</span>
<span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${Deploy.endpointUrl}</span>
<span class="w">    </span><span class="nt">Configuration</span><span class="p">:</span>
<span class="w">      </span><span class="nt">Steps</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mvn --batch-mode --no-transfer-progress soapui:test -Dsoapui.endpoint=${endpointUrl}</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mvn --batch-mode --no-transfer-progress compile jmeter:jmeter jmeter:results -Djmeter.endpoint=${endpointUrl} -Djmeter.threads=300 -Djmeter.duration=300 -Djmeter.throughput=6000</span>
<span class="w">    </span><span class="nt">Outputs</span><span class="p">:</span>
<span class="w">      </span><span class="nt">AutoDiscoverReports</span><span class="p">:</span>
<span class="w">        </span><span class="nt">Enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">        </span><span class="nt">IncludePaths</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">target/soapui-reports/*</span>
<span class="w">        </span><span class="nt">ReportNamePrefix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Beta</span>
<span class="w">        </span><span class="nt">SuccessCriteria</span><span class="p">:</span>
<span class="w">          </span><span class="nt">PassRate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
</code></pre></div>
<p>The results of the unit tests are uploaded to Amazon CodeCatalyst to track over time.</p>
</details>
<h2 id="test-gamma">Test (Gamma)<a class="headerlink" href="#test-gamma" title="Permanent link">&para;</a></h2>
<details class="required" open="open">
<summary>Launch Environment</summary>
<p><img alt="Deployment" src="../assets/ri-codecatalyst-pipeline-deployment.png" /></p>
<p>The infrastructure for each environment is defined in <a href="https://aws.amazon.com/cdk/">AWS Cloud Development Kit</a>:</p>
<div class="highlight"><pre><span></span><code><span class="k">super</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">props</span><span class="p">);</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">AssetImage</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;build&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">appName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Stack</span><span class="p">.</span><span class="k">of</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="nx">stackName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
<span class="w">  </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sb">`-</span><span class="si">${</span><span class="nx">Stack</span><span class="p">.</span><span class="k">of</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">region</span><span class="si">}</span><span class="sb">-`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;-&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">vpc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ec2</span><span class="p">.</span><span class="nx">Vpc</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Vpc&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">maxAzs</span><span class="o">:</span><span class="w"> </span><span class="kt">3</span><span class="p">,</span>
<span class="w">  </span><span class="nx">natGateways</span><span class="o">:</span><span class="w"> </span><span class="kt">props?.natGateways</span><span class="p">,</span>
<span class="p">});</span>
<span class="ow">new</span><span class="w"> </span><span class="nx">FlowLog</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;VpcFlowLog&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">resourceType</span><span class="o">:</span><span class="w"> </span><span class="kt">FlowLogResourceType.fromVpc</span><span class="p">(</span><span class="nx">vpc</span><span class="p">),</span>
<span class="p">});</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">dbName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;fruits&#39;</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">dbSecret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">DatabaseSecret</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;AuroraSecret&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;fruitapi&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">secretName</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">appName</span><span class="si">}</span><span class="sb">-DB`</span><span class="p">,</span>
<span class="p">});</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">DatabaseCluster</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Database&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">engine</span><span class="o">:</span><span class="w"> </span><span class="kt">DatabaseClusterEngine.auroraMysql</span><span class="p">({</span>
<span class="w">    </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="kt">AuroraMysqlEngineVersion.VER_3_07_1</span><span class="p">,</span>
<span class="w">  </span><span class="p">}),</span>
<span class="w">  </span><span class="nx">credentials</span><span class="o">:</span><span class="w"> </span><span class="kt">Credentials.fromSecret</span><span class="p">(</span><span class="nx">dbSecret</span><span class="p">),</span>
<span class="w">  </span><span class="nx">writer</span><span class="o">:</span><span class="w"> </span><span class="kt">ClusterInstance.serverlessV2</span><span class="p">(</span><span class="s1">&#39;writer&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="nx">defaultDatabaseName</span><span class="o">:</span><span class="w"> </span><span class="kt">dbName</span><span class="p">,</span>
<span class="w">  </span><span class="nx">serverlessV2MaxCapacity</span><span class="o">:</span><span class="w"> </span><span class="kt">2</span><span class="p">,</span>
<span class="w">  </span><span class="nx">serverlessV2MinCapacity</span><span class="o">:</span><span class="w"> </span><span class="kt">0.5</span><span class="p">,</span>
<span class="w">  </span><span class="nx">vpc</span><span class="p">,</span>
<span class="w">  </span><span class="nx">clusterIdentifier</span><span class="o">:</span><span class="w"> </span><span class="kt">appName</span><span class="p">,</span>
<span class="w">  </span><span class="nx">storageEncrypted</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="p">});</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">cluster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ecs</span><span class="p">.</span><span class="nx">Cluster</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Cluster&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">vpc</span><span class="p">,</span>
<span class="w">  </span><span class="nx">containerInsights</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="w">  </span><span class="nx">clusterName</span><span class="o">:</span><span class="w"> </span><span class="kt">appName</span><span class="p">,</span>
<span class="p">});</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">appLogGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">LogGroup</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;AppLogGroup&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">retention</span><span class="o">:</span><span class="w"> </span><span class="kt">RetentionDays.ONE_WEEK</span><span class="p">,</span>
<span class="w">  </span><span class="nx">logGroupName</span><span class="o">:</span><span class="w"> </span><span class="sb">`/aws/ecs/service/</span><span class="si">${</span><span class="nx">appName</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">  </span><span class="nx">removalPolicy</span><span class="o">:</span><span class="w"> </span><span class="kt">RemovalPolicy.DESTROY</span><span class="p">,</span>
<span class="p">});</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">deploymentConfig</span><span class="o">:</span><span class="w"> </span><span class="kt">IEcsDeploymentConfig</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">props</span><span class="o">?</span><span class="p">.</span><span class="nx">deploymentConfigName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">deploymentConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">EcsDeploymentConfig</span><span class="p">.</span><span class="nx">fromEcsDeploymentConfigName</span><span class="p">(</span>
<span class="w">    </span><span class="k">this</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;DeploymentConfig&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">props</span><span class="p">.</span><span class="nx">deploymentConfigName</span><span class="p">,</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">appConfigEnabled</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="nx">props</span><span class="o">?</span><span class="p">.</span><span class="nx">appConfigRoleArn</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">  </span><span class="nx">props</span><span class="p">.</span><span class="nx">appConfigRoleArn</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ApplicationLoadBalancedCodeDeployedFargateService</span><span class="p">(</span>
<span class="w">  </span><span class="k">this</span><span class="p">,</span>
<span class="w">  </span><span class="s1">&#39;Api&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nx">cluster</span><span class="p">,</span>
<span class="w">    </span><span class="nx">capacityProviderStrategies</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">capacityProvider</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;FARGATE_SPOT&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">weight</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nx">minHealthyPercent</span><span class="o">:</span><span class="w"> </span><span class="kt">50</span><span class="p">,</span>
<span class="w">    </span><span class="nx">maxHealthyPercent</span><span class="o">:</span><span class="w"> </span><span class="kt">200</span><span class="p">,</span>
<span class="w">    </span><span class="nx">desiredCount</span><span class="o">:</span><span class="w"> </span><span class="kt">3</span><span class="p">,</span>
<span class="w">    </span><span class="nx">cpu</span><span class="o">:</span><span class="w"> </span><span class="kt">512</span><span class="p">,</span>
<span class="w">    </span><span class="nx">memoryLimitMiB</span><span class="o">:</span><span class="w"> </span><span class="kt">1024</span><span class="p">,</span>
<span class="w">    </span><span class="nx">taskImageOptions</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">image</span><span class="p">,</span>
<span class="w">      </span><span class="nx">containerName</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">containerPort</span><span class="o">:</span><span class="w"> </span><span class="kt">8080</span><span class="p">,</span>
<span class="w">      </span><span class="nx">family</span><span class="o">:</span><span class="w"> </span><span class="kt">appName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">logDriver</span><span class="o">:</span><span class="w"> </span><span class="kt">AwsLogDriver.awsLogs</span><span class="p">({</span>
<span class="w">        </span><span class="nx">logGroup</span><span class="o">:</span><span class="w"> </span><span class="kt">appLogGroup</span><span class="p">,</span>
<span class="w">        </span><span class="nx">streamPrefix</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;service&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">}),</span>
<span class="w">      </span><span class="nx">secrets</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">SPRING_DATASOURCE_USERNAME</span><span class="o">:</span><span class="w"> </span><span class="kt">Secret.fromSecretsManager</span><span class="p">(</span>
<span class="w">          </span><span class="nx">dbSecret</span><span class="p">,</span>
<span class="w">          </span><span class="s1">&#39;username&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="p">),</span>
<span class="w">        </span><span class="nx">SPRING_DATASOURCE_PASSWORD</span><span class="o">:</span><span class="w"> </span><span class="kt">Secret.fromSecretsManager</span><span class="p">(</span>
<span class="w">          </span><span class="nx">dbSecret</span><span class="p">,</span>
<span class="w">          </span><span class="s1">&#39;password&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="p">),</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">environment</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">SPRING_DATASOURCE_URL</span><span class="o">:</span><span class="w"> </span><span class="sb">`jdbc:mysql://</span><span class="si">${</span><span class="nx">db</span><span class="p">.</span><span class="nx">clusterEndpoint</span><span class="p">.</span><span class="nx">hostname</span><span class="si">}</span><span class="sb">:</span><span class="si">${</span><span class="nx">db</span><span class="p">.</span><span class="nx">clusterEndpoint</span><span class="p">.</span><span class="nx">port</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">dbName</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">        </span><span class="nx">APPCONFIG_AGENT_APPLICATION</span><span class="o">:</span>
<span class="w">          </span><span class="kt">this.node.tryGetContext</span><span class="p">(</span><span class="s1">&#39;workloadName&#39;</span><span class="p">),</span>
<span class="w">        </span><span class="nx">APPCONFIG_AGENT_ENVIRONMENT</span><span class="o">:</span>
<span class="w">          </span><span class="kt">this.node.tryGetContext</span><span class="p">(</span><span class="s1">&#39;environmentName&#39;</span><span class="p">),</span>
<span class="w">        </span><span class="nx">APPCONFIG_AGENT_ENABLED</span><span class="o">:</span><span class="w"> </span><span class="kt">appConfigEnabled.toString</span><span class="p">(),</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">deregistrationDelay</span><span class="o">:</span><span class="w"> </span><span class="kt">Duration.seconds</span><span class="p">(</span><span class="mf">5</span><span class="p">),</span>
<span class="w">    </span><span class="nx">responseTimeAlarmThreshold</span><span class="o">:</span><span class="w"> </span><span class="kt">Duration.seconds</span><span class="p">(</span><span class="mf">3</span><span class="p">),</span>
<span class="w">    </span><span class="nx">targetHealthCheck</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">healthyThresholdCount</span><span class="o">:</span><span class="w"> </span><span class="kt">2</span><span class="p">,</span>
<span class="w">      </span><span class="nx">unhealthyThresholdCount</span><span class="o">:</span><span class="w"> </span><span class="kt">2</span><span class="p">,</span>
<span class="w">      </span><span class="nx">interval</span><span class="o">:</span><span class="w"> </span><span class="kt">Duration.seconds</span><span class="p">(</span><span class="mf">60</span><span class="p">),</span>
<span class="w">      </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/actuator/health&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">deploymentConfig</span><span class="p">,</span>
<span class="w">    </span><span class="nx">terminationWaitTime</span><span class="o">:</span><span class="w"> </span><span class="kt">Duration.minutes</span><span class="p">(</span><span class="mf">5</span><span class="p">),</span>
<span class="w">    </span><span class="nx">apiCanaryTimeout</span><span class="o">:</span><span class="w"> </span><span class="kt">Duration.seconds</span><span class="p">(</span><span class="mf">5</span><span class="p">),</span>
<span class="w">    </span><span class="nx">apiTestSteps</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;getAll&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/api/fruits&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">jmesPath</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;length(@)&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">expectedValue</span><span class="o">:</span><span class="w"> </span><span class="kt">5</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">);</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">appConfigEnabled</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">service</span><span class="p">.</span><span class="nx">taskDefinition</span><span class="p">.</span><span class="nx">addContainer</span><span class="p">(</span><span class="s1">&#39;appconfig-agent&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">image</span><span class="o">:</span><span class="w"> </span><span class="kt">ecs.ContainerImage.fromRegistry</span><span class="p">(</span>
<span class="w">      </span><span class="s1">&#39;public.ecr.aws/aws-appconfig/aws-appconfig-agent:2.x&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">),</span>
<span class="w">    </span><span class="nx">essential</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span>
<span class="w">    </span><span class="nx">logging</span><span class="o">:</span><span class="w"> </span><span class="kt">AwsLogDriver.awsLogs</span><span class="p">({</span>
<span class="w">      </span><span class="nx">logGroup</span><span class="o">:</span><span class="w"> </span><span class="kt">appLogGroup</span><span class="p">,</span>
<span class="w">      </span><span class="nx">streamPrefix</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;service&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">}),</span>
<span class="w">    </span><span class="nx">environment</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">SERVICE_REGION</span><span class="o">:</span><span class="w"> </span><span class="kt">this.region</span><span class="p">,</span>
<span class="w">      </span><span class="nx">ROLE_ARN</span><span class="o">:</span><span class="w"> </span><span class="kt">props</span><span class="o">!</span><span class="p">.</span><span class="nx">appConfigRoleArn</span><span class="o">!</span><span class="p">,</span>
<span class="w">      </span><span class="nx">ROLE_SESSION_NAME</span><span class="o">:</span><span class="w"> </span><span class="kt">appName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">LOG_LEVEL</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;info&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">portMappings</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span><span class="w"> </span><span class="nx">containerPort</span><span class="o">:</span><span class="w"> </span><span class="kt">2772</span><span class="w"> </span><span class="p">}],</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">service</span><span class="p">.</span><span class="nx">taskDefinition</span><span class="p">.</span><span class="nx">addToTaskRolePolicy</span><span class="p">(</span>
<span class="w">    </span><span class="ow">new</span><span class="w"> </span><span class="nx">PolicyStatement</span><span class="p">({</span>
<span class="w">      </span><span class="nx">actions</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;sts:AssumeRole&#39;</span><span class="p">],</span>
<span class="w">      </span><span class="nx">resources</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nx">props</span><span class="o">!</span><span class="p">.</span><span class="nx">appConfigRoleArn</span><span class="o">!</span><span class="p">],</span>
<span class="w">    </span><span class="p">}),</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">service</span><span class="p">.</span><span class="nx">service</span><span class="p">.</span><span class="nx">connections</span><span class="p">.</span><span class="nx">allowTo</span><span class="p">(</span>
<span class="w">  </span><span class="nx">db</span><span class="p">,</span>
<span class="w">  </span><span class="nx">ec2</span><span class="p">.</span><span class="nx">Port</span><span class="p">.</span><span class="nx">tcp</span><span class="p">(</span><span class="nx">db</span><span class="p">.</span><span class="nx">clusterEndpoint</span><span class="p">.</span><span class="nx">port</span><span class="p">),</span>
<span class="p">);</span>

<span class="k">this</span><span class="p">.</span><span class="nx">apiUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">CfnOutput</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;endpointUrl&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="sb">`http://</span><span class="si">${</span><span class="nx">service</span><span class="p">.</span><span class="nx">listener</span><span class="p">.</span><span class="nx">loadBalancer</span><span class="p">.</span><span class="nx">loadBalancerDnsName</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="p">});</span>
</code></pre></div>
<p>The CDK deployment is then performed for each environment:</p>
<div class="highlight"><pre><span></span><code><span class="nt">Deploy</span><span class="p">:</span>
<span class="w">    </span><span class="nt">Identifier</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws/cdk-deploy@v1</span>
<span class="w">    </span><span class="nt">DependsOn</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Build</span>
<span class="w">    </span><span class="nt">Inputs</span><span class="p">:</span>
<span class="w">      </span><span class="nt">Artifacts</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">package</span>
<span class="w">    </span><span class="nt">Environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Beta</span>
<span class="w">      </span><span class="nt">Connections</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">beta</span>
<span class="w">          </span><span class="nt">Role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">codecatalyst</span>
<span class="w">    </span><span class="nt">Configuration</span><span class="p">:</span>
<span class="w">      </span><span class="nt">StackName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit-api</span>
<span class="w">      </span><span class="nt">Region</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">us-west-2</span>
<span class="w">      </span><span class="nt">Context</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{&quot;deploymentConfigurationName&quot;:&quot;CodeDeployDefault.ECSCanary10Percent5Minutes&quot;}&#39;</span>
<span class="w">      </span><span class="nt">CfnOutputVariables</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;[&quot;endpointUrl&quot;]&#39;</span>
</code></pre></div>
</details>
<details class="required" open="open">
<summary>Database Deploy</summary>
<p>Spring Boot is configured to run <a href="https://www.liquibase.org/">Liquibase</a> on startup. This reads the configuration in <code>src/main/resources/db/changelog/db.changelog-master.yml</code> to define the tables and initial data for the database:</p>
<div class="highlight"><pre><span></span><code><span class="nt">databaseChangeLog</span><span class="p">:</span>
<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">changeSet</span><span class="p">:</span>
<span class="w">       </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">       </span><span class="nt">author</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS</span>
<span class="w">       </span><span class="nt">changes</span><span class="p">:</span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">createTable</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">id</span>
<span class="w">               </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bigint</span>
<span class="w">               </span><span class="nt">autoIncrement</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">               </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">                   </span><span class="nt">primaryKey</span><span class="p">:</span><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">                   </span><span class="nt">nullable</span><span class="p">:</span><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span>
<span class="w">               </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">varchar(250)</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">insert</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Apple</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">insert</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Orange</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">insert</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Banana</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">insert</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Cherry</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">insert</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Grape</span>

<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">changeSet</span><span class="p">:</span>
<span class="w">       </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2&quot;</span>
<span class="w">       </span><span class="nt">author</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS</span>
<span class="w">       </span><span class="nt">changes</span><span class="p">:</span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">addColumn</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">classification</span>
<span class="w">               </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">varchar(250)</span>
<span class="w">               </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">                 </span><span class="nt">nullable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">update</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">classification</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pome</span>
<span class="w">           </span><span class="nt">where</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name=&#39;Apple&#39;</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">update</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">classification</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">berry</span>
<span class="w">           </span><span class="nt">where</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name=&#39;Orange&#39;</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">update</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">classification</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">berry</span>
<span class="w">           </span><span class="nt">where</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name=&#39;Banana&#39;</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">update</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">classification</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">drupe</span>
<span class="w">           </span><span class="nt">where</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name=&#39;Cherry&#39;</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">update</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">classification</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">berry</span>
<span class="w">           </span><span class="nt">where</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name=&#39;Grape&#39;</span>
</code></pre></div>
</details>
<details class="required" open="open">
<summary>Deploy Software</summary>
<p>The <em>Launch Environment</em> action above creates a new <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definitions.html">Amazon ECS Task Definition</a> for the new docker image and then updates the Amazon ECS Service to use the new Task Definition.</p>
</details>
<details class="required" open="open">
<summary>Application Monitoring &amp; Logging</summary>
<p><a href="https://aws.amazon.com/ecs/">Amazon ECS</a> uses <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/working_with_metrics.html">Amazon CloudWatch Metrics</a> and <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/WhatIsCloudWatchLogs.html">Amazon CloudWatch Logs</a> for observability by default.</p>
</details>
<details class="required" open="open">
<summary>Synthetic Tests</summary>
<p><a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Synthetics_Canaries.html">Amazon CloudWatch Synthetics</a> is used to continuously deliver traffic to the application and assert that requests are successful and responses are received within a given threshold. The canary is defined via CDK using the <a href="https://constructs.dev/packages/@cdklabs/cdk-ecs-codedeploy">@cdklabs/cdk-ecs-codedeploy</a> construct:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ApplicationLoadBalancedCodeDeployedFargateService</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Api&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">...</span>

<span class="w">  </span><span class="nx">apiCanaryTimeout</span><span class="o">:</span><span class="w"> </span><span class="kt">Duration.seconds</span><span class="p">(</span><span class="mf">5</span><span class="p">),</span>
<span class="w">  </span><span class="nx">apiTestSteps</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;getAll&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/api/fruits&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">jmesPath</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;length(@)&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">expectedValue</span><span class="o">:</span><span class="w"> </span><span class="kt">5</span><span class="p">,</span>
<span class="w">  </span><span class="p">}],</span>
</code></pre></div>
</details>
<details class="required" open="open">
<summary>Performance Tests</summary>
<p><a href="https://jmeter.apache.org/">Apache JMeter</a> is used to run performance tests against the deployed application. The tests are stored in <code>src/test/jmeter</code> and added to the CodeCatalyst workflow:</p>
<div class="highlight"><pre><span></span><code><span class="nt">Test</span><span class="p">:</span>
<span class="w">    </span><span class="nt">Identifier</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws/managed-test@v1</span>
<span class="w">    </span><span class="nt">Inputs</span><span class="p">:</span>
<span class="w">      </span><span class="nt">Artifacts</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">package</span>
<span class="w">      </span><span class="nt">Variables</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">endpointUrl</span>
<span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${Deploy.endpointUrl}</span>
<span class="w">    </span><span class="nt">Configuration</span><span class="p">:</span>
<span class="w">      </span><span class="nt">Steps</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mvn --batch-mode --no-transfer-progress soapui:test -Dsoapui.endpoint=${endpointUrl}</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mvn --batch-mode --no-transfer-progress compile jmeter:jmeter jmeter:results -Djmeter.endpoint=${endpointUrl} -Djmeter.threads=300 -Djmeter.duration=300 -Djmeter.throughput=6000</span>
<span class="w">    </span><span class="nt">Outputs</span><span class="p">:</span>
<span class="w">      </span><span class="nt">AutoDiscoverReports</span><span class="p">:</span>
<span class="w">        </span><span class="nt">Enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">        </span><span class="nt">IncludePaths</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">target/soapui-reports/*</span>
<span class="w">        </span><span class="nt">ReportNamePrefix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Beta</span>
<span class="w">        </span><span class="nt">SuccessCriteria</span><span class="p">:</span>
<span class="w">          </span><span class="nt">PassRate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
</code></pre></div>
</details>
<details class="recommended" open="open">
<summary>Resilience Tests</summary>
<p><code>Not Implemented</code></p>
</details>
<details class="recommended" open="open">
<summary>Dynamic Application Security Testing (DAST)</summary>
<p><code>Not Implemented</code></p>
</details>
<h2 id="prod">Prod<a class="headerlink" href="#prod" title="Permanent link">&para;</a></h2>
<details class="recommended" open="open">
<summary>Manual Approval</summary>
<p><code>Not Implemented</code></p>
</details>
<details class="required" open="open">
<summary>Database Deploy</summary>
<p>Spring Boot is configured to run <a href="https://www.liquibase.org/">Liquibase</a> on startup. This reads the configuration in <code>src/main/resources/db/changelog/db.changelog-master.yml</code> to define the tables and initial data for the database:</p>
<div class="highlight"><pre><span></span><code><span class="nt">databaseChangeLog</span><span class="p">:</span>
<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">changeSet</span><span class="p">:</span>
<span class="w">       </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">       </span><span class="nt">author</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS</span>
<span class="w">       </span><span class="nt">changes</span><span class="p">:</span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">createTable</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">id</span>
<span class="w">               </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bigint</span>
<span class="w">               </span><span class="nt">autoIncrement</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">               </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">                   </span><span class="nt">primaryKey</span><span class="p">:</span><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">                   </span><span class="nt">nullable</span><span class="p">:</span><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span>
<span class="w">               </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">varchar(250)</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">insert</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Apple</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">insert</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Orange</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">insert</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Banana</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">insert</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Cherry</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">insert</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Grape</span>

<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">changeSet</span><span class="p">:</span>
<span class="w">       </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2&quot;</span>
<span class="w">       </span><span class="nt">author</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS</span>
<span class="w">       </span><span class="nt">changes</span><span class="p">:</span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">addColumn</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">classification</span>
<span class="w">               </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">varchar(250)</span>
<span class="w">               </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">                 </span><span class="nt">nullable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">update</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">classification</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pome</span>
<span class="w">           </span><span class="nt">where</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name=&#39;Apple&#39;</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">update</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">classification</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">berry</span>
<span class="w">           </span><span class="nt">where</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name=&#39;Orange&#39;</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">update</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">classification</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">berry</span>
<span class="w">           </span><span class="nt">where</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name=&#39;Banana&#39;</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">update</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">classification</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">drupe</span>
<span class="w">           </span><span class="nt">where</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name=&#39;Cherry&#39;</span>

<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">update</span><span class="p">:</span>
<span class="w">           </span><span class="nt">tableName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fruit</span>
<span class="w">           </span><span class="nt">columns</span><span class="p">:</span>
<span class="w">           </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span>
<span class="w">               </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">classification</span>
<span class="w">               </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">berry</span>
<span class="w">           </span><span class="nt">where</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name=&#39;Grape&#39;</span>
</code></pre></div>
</details>
<details class="required" open="open">
<summary>Progressive Deployment</summary>
<p>Progressive deployment is implemented with <a href="https://aws.amazon.com/codedeploy/">AWS CodeDeploy</a> for ECS. CodeDeploy performs a <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/deployment-type-bluegreen.html">linear blue/green</a> by deploying the new task definition as a new task with a separate target group and then shifting 10% of traffic every minute until all traffic is shifted. A CloudWatch alarm is monitored by CodeDeploy and an automatic rollback is triggered if the alarm exceeds the threshold.</p>
<p><img alt="" src="../assets/traffic-shift.png" /></p>
<p>Implementation of this type deployment presents challenges due to the following limitations:</p>
<ul>
<li><a href="https://github.com/aws/aws-cdk/issues/19163">aws/aws-cdk #19163</a> - CDK Pipelines aren't intended to be used with CodeDeploy actions.</li>
<li><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/blue-green.html#blue-green-considerations">AWS CloudFormation User Guide</a> - The use of <code>AWS::CodeDeploy::BlueGreen</code> hooks and <code>AWS::CodeDeployBlueGreen</code> restricts the types of changes that can be made. Additionally, you can't use auto-rollback capabilities of CodeDeploy.</li>
<li><a href="https://github.com/aws/aws-cdk/issues/5170">aws/aws-cdk #5170</a> - CDK doesn't support defining CloudFormation rollback triggers. This rules out CloudFormation based blue/green deployments.</li>
</ul>
<p>The solution was to use the <a href="https://constructs.dev/packages/@cdklabs/cdk-ecs-codedeploy">@cdklabs/cdk-ecs-codedeploy</a> construct from the Construct Hub which addresses <a href="https://github.com/aws/aws-cdk/issues/1559">aws/aws-cdk #1559</a> - Lack of support for Blue/Green ECS Deployment in CDK. </p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ApplicationLoadBalancedCodeDeployedFargateService</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Api&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">cluster</span><span class="p">,</span>
<span class="w">  </span><span class="nx">capacityProviderStrategies</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nx">capacityProvider</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;FARGATE_SPOT&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">weight</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nx">minHealthyPercent</span><span class="o">:</span><span class="w"> </span><span class="kt">50</span><span class="p">,</span>
<span class="w">  </span><span class="nx">maxHealthyPercent</span><span class="o">:</span><span class="w"> </span><span class="kt">200</span><span class="p">,</span>
<span class="w">  </span><span class="nx">desiredCount</span><span class="o">:</span><span class="w"> </span><span class="kt">3</span><span class="p">,</span>
<span class="w">  </span><span class="nx">cpu</span><span class="o">:</span><span class="w"> </span><span class="kt">512</span><span class="p">,</span>
<span class="w">  </span><span class="nx">memoryLimitMiB</span><span class="o">:</span><span class="w"> </span><span class="kt">1024</span><span class="p">,</span>
<span class="w">  </span><span class="nx">taskImageOptions</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">image</span><span class="p">,</span>
<span class="w">    </span><span class="nx">containerName</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">containerPort</span><span class="o">:</span><span class="w"> </span><span class="kt">8080</span><span class="p">,</span>
<span class="w">    </span><span class="nx">family</span><span class="o">:</span><span class="w"> </span><span class="kt">appName</span><span class="p">,</span>
<span class="w">    </span><span class="nx">logDriver</span><span class="o">:</span><span class="w"> </span><span class="kt">AwsLogDriver.awsLogs</span><span class="p">({</span>
<span class="w">      </span><span class="nx">logGroup</span><span class="o">:</span><span class="w"> </span><span class="kt">appLogGroup</span><span class="p">,</span>
<span class="w">      </span><span class="nx">streamPrefix</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;service&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">}),</span>
<span class="w">    </span><span class="nx">secrets</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">SPRING_DATASOURCE_USERNAME</span><span class="o">:</span><span class="w"> </span><span class="kt">Secret.fromSecretsManager</span><span class="p">(</span><span class="w"> </span><span class="nx">dbSecret</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;username&#39;</span><span class="w"> </span><span class="p">),</span>
<span class="w">      </span><span class="nx">SPRING_DATASOURCE_PASSWORD</span><span class="o">:</span><span class="w"> </span><span class="kt">Secret.fromSecretsManager</span><span class="p">(</span><span class="w"> </span><span class="nx">dbSecret</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;password&#39;</span><span class="w"> </span><span class="p">),</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">environment</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">SPRING_DATASOURCE_URL</span><span class="o">:</span><span class="w"> </span><span class="sb">`jdbc:mysql://</span><span class="si">${</span><span class="nx">db</span><span class="p">.</span><span class="nx">clusterEndpoint</span><span class="p">.</span><span class="nx">hostname</span><span class="si">}</span><span class="sb">:</span><span class="si">${</span><span class="nx">db</span><span class="p">.</span><span class="nx">clusterEndpoint</span><span class="p">.</span><span class="nx">port</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">dbName</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">deregistrationDelay</span><span class="o">:</span><span class="w"> </span><span class="kt">Duration.seconds</span><span class="p">(</span><span class="mf">5</span><span class="p">),</span>
<span class="w">  </span><span class="nx">responseTimeAlarmThreshold</span><span class="o">:</span><span class="w"> </span><span class="kt">Duration.seconds</span><span class="p">(</span><span class="mf">3</span><span class="p">),</span>
<span class="w">  </span><span class="nx">healthCheck</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">healthyThresholdCount</span><span class="o">:</span><span class="w"> </span><span class="kt">2</span><span class="p">,</span>
<span class="w">    </span><span class="nx">unhealthyThresholdCount</span><span class="o">:</span><span class="w"> </span><span class="kt">2</span><span class="p">,</span>
<span class="w">    </span><span class="nx">interval</span><span class="o">:</span><span class="w"> </span><span class="kt">Duration.seconds</span><span class="p">(</span><span class="mf">60</span><span class="p">),</span>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/actuator/health&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">deploymentConfig</span><span class="p">,</span>
<span class="w">  </span><span class="nx">terminationWaitTime</span><span class="o">:</span><span class="w"> </span><span class="kt">Duration.minutes</span><span class="p">(</span><span class="mf">5</span><span class="p">),</span>
<span class="w">  </span><span class="nx">apiCanaryTimeout</span><span class="o">:</span><span class="w"> </span><span class="kt">Duration.seconds</span><span class="p">(</span><span class="mf">5</span><span class="p">),</span>
<span class="w">  </span><span class="nx">apiTestSteps</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;getAll&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/api/fruits&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">jmesPath</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;length(@)&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">expectedValue</span><span class="o">:</span><span class="w"> </span><span class="kt">5</span><span class="p">,</span>
<span class="w">  </span><span class="p">}],</span>
<span class="p">});</span>

<span class="k">this</span><span class="p">.</span><span class="nx">apiUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">CfnOutput</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;endpointUrl&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="sb">`http://</span><span class="si">${</span><span class="nx">service</span><span class="p">.</span><span class="nx">listener</span><span class="p">.</span><span class="nx">loadBalancer</span><span class="p">.</span><span class="nx">loadBalancerDnsName</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="p">});</span>
<span class="sb">```rrideLogicalId(&#39;DeploymentId&#39;);</span>
</code></pre></div>
<p>Deployments are made incrementally across regions as waves using the <a href="https://docs.aws.amazon.com/codecatalyst/latest/userguide/workflows-group-actions.html">action groups</a> and the <a href="https://docs.aws.amazon.com/codecatalyst/latest/userguide/workflows-group-actions.html">CDK deploy action</a>. Each wave contains a list of regions to deploy to in parallel. One wave must fully complete before the next wave starts. The diagram below shows how each wave deploys to 2 regions at a time.</p>
<p><img alt="" src="../assets/codecatalyst-prod-waves.png" /></p>
</details>
<details class="required" open="open">
<summary>Synthetic Tests</summary>
<p><a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Synthetics_Canaries.html">Amazon CloudWatch Synthetics</a> is used to continuously deliver traffic to the application and assert that requests are successful and responses are received within a given threshold. The canary is defined via CDK using the <a href="https://constructs.dev/packages/@cdklabs/cdk-ecs-codedeploy">@cdklabs/cdk-ecs-codedeploy</a> construct:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ApplicationLoadBalancedCodeDeployedFargateService</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Api&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">...</span>

<span class="w">  </span><span class="nx">apiCanaryTimeout</span><span class="o">:</span><span class="w"> </span><span class="kt">Duration.seconds</span><span class="p">(</span><span class="mf">5</span><span class="p">),</span>
<span class="w">  </span><span class="nx">apiTestSteps</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;getAll&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/api/fruits&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">jmesPath</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;length(@)&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">expectedValue</span><span class="o">:</span><span class="w"> </span><span class="kt">5</span><span class="p">,</span>
<span class="w">  </span><span class="p">}],</span>
</code></pre></div>
</details>
<h2 id="frequently-asked-questions">Frequently Asked Questions<a class="headerlink" href="#frequently-asked-questions" title="Permanent link">&para;</a></h2>
<details class="faq" open="open">
<summary>What <a href="https://docs.aws.amazon.com/wellarchitected/latest/operational-excellence-pillar/operating-model.html">operating models</a> does this reference implementation support?</summary>
<p>This reference implementation can accomodate any operation model with minor updates:</p>
<ul>
<li><a href="https://docs.aws.amazon.com/wellarchitected/latest/operational-excellence-pillar/fully-separated-operating-model.html">Fully Separated</a> - Restrict the role that CDK uses for CloudFormation execution to only create resources from approved product portfolios in <a href="https://aws.amazon.com/servicecatalog/">AWS Service Catalog</a>. Ownership of creating the products in Service Catalog is owned by the <strong>Platform Engineering</strong> team and operational support of Service Catalog is owned by the <strong>Platform Operations</strong> team. The <strong>Platform Engineering</strong> team should publish CDK constructs internally that provision AWS resources through Service Catalog. Update the CDK app in the <code>infrastructure/</code> directory to use CDK constructs provided by the <code>Platform Engineering</code> team. Use a <a href="https://docs.github.com/en/repositories/managing-your-repositorys-settings-and-features/customizing-your-repository/about-code-owners">CODEOWNERS</a> file to require all changes to the <code>infrastructure/</code> directory be approved by the <strong>Application Operations</strong> team. Additionally, restrict permissions to the <strong>Manual Approval</strong> action to only allow members of the <strong>Application Operations</strong> to approve.</li>
<li><a href="https://docs.aws.amazon.com/wellarchitected/latest/operational-excellence-pillar/separated-aeo-and-ieo-with-centralized-governance.html">Separated AEO and IEO with Centralized Governance</a> - Restrict the role that CDK uses for CloudFormation execution to only create resources from approved product portfolios in <a href="https://aws.amazon.com/servicecatalog/">AWS Service Catalog</a>. Ownership of creating the products in Service Catalog is owned by the <strong>Platform Engineering</strong> team and operational support of Service Catalog is owned by the <strong>Platform Engineering</strong> team. The <strong>Platform Engineering</strong> team should publish CDK constructs internally that provision AWS resources through Service Catalog. Update the CDK app in the <code>infrastructure/</code> directory to use CDK constructs provided by the <code>Platform Engineering</code> team.</li>
<li><a href="https://docs.aws.amazon.com/wellarchitected/latest/operational-excellence-pillar/separated-aeo-and-ieo-with-decentralized-governance.html">Separated AEO and IEO with Decentralized Governance</a> - The <strong>Platform Engineering</strong> team should publish CDK constructs internally that provision AWS resources in manner that achieve organizational compliance. Update the CDK app in the <code>infrastructure/</code> directory to use CDK constructs provided by the <code>Platform Engineering</code> team.</li>
</ul>
</details>







  
  



  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <!--
  Copyright (c) 2016-2022 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Copyright and theme information -->
<div class="md-copyright">
    
      <div class="md-copyright__highlight">
        Copyright  Amazon Web Services, Inc. and/or its affiliates. All rights reserved.
      </div>
    
    
      Made with
      <a
        href="https://squidfunk.github.io/mkdocs-material/"
        target="_blank" rel="noopener"
      >
        Material for MkDocs
      </a>
    
</div>

<a
  href="../../pdf/document.pdf"
  title="Download PDF"
  class="md-pdf"
>
  <div class="md-pdf__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M0 64C0 28.7 28.7 0 64 0h160v128c0 17.7 14.3 32 32 32h128v144H176c-35.3 0-64 28.7-64 64v144H64c-35.3 0-64-28.7-64-64V64zm384 64H256V0l128 128zM176 352h32c30.9 0 56 25.1 56 56s-25.1 56-56 56h-16v32c0 8.8-7.2 16-16 16s-16-7.2-16-16V368c0-8.8 7.2-16 16-16zm32 80c13.3 0 24-10.7 24-24s-10.7-24-24-24h-16v48h16zm96-80h32c26.5 0 48 21.5 48 48v64c0 26.5-21.5 48-48 48h-32c-8.8 0-16-7.2-16-16V368c0-8.8 7.2-16 16-16zm32 128c8.8 0 16-7.2 16-16v-64c0-8.8-7.2-16-16-16h-16v96h16zm80-112c0-8.8 7.2-16 16-16h48c8.8 0 16 7.2 16 16s-7.2 16-16 16h-32v32h32c8.8 0 16 7.2 16 16s-7.2 16-16 16h-32v48c0 8.8-7.2 16-16 16s-16-7.2-16-16V368z"/></svg>
  </div>
</a>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["toc.integrate"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.471ce7a9.min.js"></script>
      
    
  </body>
</html>